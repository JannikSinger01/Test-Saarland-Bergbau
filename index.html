<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Saar: Gestern & Heute</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f8fafc; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .glass-panel { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .tab-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-btn.active { background-color: #0f172a; color: white; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #0f172a; cursor: pointer; margin-top: -8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.1s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .leaflet-popup-content { margin: 0 !important; width: 280px !important; }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .details-content.open { max-height: 600px; transition: max-height 0.5s ease-in; }
        #welcome-overlay.hidden-overlay { opacity: 0; visibility: hidden; pointer-events: none; }
        .custom-div-icon { background: transparent; border: none; }
        .reform-alert { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .flag-box { width: 100px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s; }
        .flag-box:hover { transform: scale(1.05); }
        .flag-img { width: 100%; height: 100%; object-fit: cover; }
        .location-img { width: 100%; height: 140px; object-fit: cover; background-color: #e2e8f0; }
        .copyright-text { font-size: 9px; color: #64748b; margin-top: 4px; text-align: right; font-style: italic; }
    </style>
</head>
<body class="relative h-screen w-screen text-slate-800">

    <!-- WELCOME -->
    <div id="welcome-overlay" class="absolute inset-0 z-[9999] bg-slate-900/95 backdrop-blur-md flex items-center justify-center text-white p-6">
        <div class="max-w-5xl w-full flex flex-col items-center space-y-10 fade-in-up">
            <div class="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-16 w-full">
                <div class="flex flex-col items-center gap-2 group">
                    <div class="flag-box">
                        <img src="flaggen/alt.png" alt="Historisch" class="flag-img" onerror="this.style.display='none'; this.parentElement.classList.remove('flag-box'); this.parentElement.innerHTML='<div class=\'text-xs text-slate-500 italic\'>Historische<br>Flagge</div>'">
                    </div>
                    <span class="text-[10px] uppercase tracking-widest text-slate-400 group-hover:text-slate-200 transition-colors">Damals</span>
                </div>
                <div class="text-center space-y-2">
                    <div class="inline-block p-4 bg-white/5 rounded-full border border-white/10 shadow-2xl mb-4"><i class="ph ph-map-trifold text-6xl text-blue-400"></i></div>
                    <h1 class="text-5xl md:text-7xl font-extrabold tracking-tight text-white">Atlas Saar</h1>
                    <div class="h-1.5 w-24 bg-gradient-to-r from-blue-500 to-purple-500 mx-auto rounded-full opacity-90"></div>
                </div>
                <div class="flex flex-col items-center gap-2 group">
                    <div class="flag-box">
                        <img src="flaggen/neu.png" alt="Aktuell" class="flag-img" onerror="this.style.display='none'; this.parentElement.classList.remove('flag-box'); this.parentElement.innerHTML='<div class=\'text-xs text-slate-500 italic\'>Aktuelle<br>Flagge</div>'">
                    </div>
                    <span class="text-[10px] uppercase tracking-widest text-slate-400 group-hover:text-slate-200 transition-colors">Heute</span>
                </div>
            </div>
            <p class="text-xl md:text-3xl text-slate-200 leading-relaxed font-light max-w-3xl mx-auto text-center">Wie hat die Ära der <span class="text-red-400 font-medium border-b border-red-400/30">Schwerindustrie</span> das Gesicht des <span class="text-blue-400 font-medium border-b border-blue-400/30">heutigen Saarlandes</span> geformt?</p>
            <button onclick="closeWelcome()" class="mt-12 px-10 py-4 bg-white text-slate-900 rounded-full font-bold text-xl shadow-lg hover:bg-blue-50 hover:scale-105 hover:shadow-[0_0_60px_rgba(255,255,255,0.4)] transition-all transform flex items-center gap-3 mx-auto"><span>Karte erkunden</span><i class="ph-bold ph-arrow-right"></i></button>
            <div class="pt-6 text-xs text-slate-500 font-mono">Version 48.0 • Datenstand: 2025</div>
        </div>
    </div>

    <!-- NAV -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] glass-panel rounded-full p-1.5 flex shadow-xl border border-white/40">
        <button onclick="switchMode('history')" id="btn-history" class="tab-btn active px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap"><i class="ph-fill ph-factory text-lg"></i> Berg- und Stahlbau</button>
        <button onclick="switchMode('urban')" id="btn-urban" class="tab-btn px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap"><i class="ph-fill ph-buildings text-lg"></i> Urbanisierung</button>
        <button onclick="switchMode('transport')" id="btn-transport" class="tab-btn px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap"><i class="ph-fill ph-train text-lg"></i> Verkehr</button>
    </div>

    <!-- CONTROLS -->
    <div id="view-controls" class="absolute top-24 left-4 z-[1000] glass-panel p-2 rounded-lg shadow-lg flex gap-2">
        <button onclick="setViewMode('details')" id="view-details" class="px-3 py-1.5 rounded-md text-xs font-bold bg-slate-800 text-white shadow transition-all flex items-center gap-1"><i class="ph-fill ph-map-pin"></i> Details</button>
        <button onclick="setViewMode('overview')" id="view-overview" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all flex items-center gap-1"><i class="ph-fill ph-wave-sine"></i> Übersicht</button>
    </div>

    <!-- POPULATION BOX -->
    <div id="total-pop-display" class="absolute top-36 left-4 z-[1000] glass-panel p-4 rounded-xl shadow-lg hidden w-56 border-l-4 border-blue-500 transition-all">
        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Bevölkerung Saarland</div>
        <div class="text-2xl font-extrabold text-slate-800 tabular-nums" id="total-pop-value">---</div>
        <div class="text-[10px] text-slate-500 mt-1 text-right font-mono" id="total-pop-year">Jahr: 2024</div>
    </div>

    <!-- TIME SLIDER -->
    <div id="time-slider-container" class="absolute top-24 left-1/2 transform -translate-x-1/2 z-[1000] glass-panel p-5 rounded-xl shadow-xl w-80 hidden">
        <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest"><span>1926</span><span>1950</span><span>1974</span><span>2024</span></div>
        <input type="range" id="yearSlider" min="1926" max="2024" step="1" value="2024" oninput="updateUrbanMap(this.value)">
        <div class="flex justify-between items-end mt-2">
            <div class="font-bold text-2xl text-slate-800 tabular-nums" id="yearDisplay">2024</div>
            <div id="reform-badge" class="hidden text-[10px] font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded border border-amber-200 reform-alert flex items-center gap-1"><i class="ph-bold ph-warning"></i> Gebietsreform</div>
        </div>
    </div>

    <!-- LEGEND -->
    <div id="legend-panel" class="absolute bottom-10 left-4 z-[1000] glass-panel p-4 rounded-xl shadow-lg max-w-[200px] hidden md:block">
        <h3 class="font-bold text-[10px] text-slate-400 uppercase mb-2 tracking-widest">Legende</h3>
        <div id="legend-content" class="space-y-2.5 text-xs font-medium text-slate-700"></div>
    </div>

    <!-- SIDEBAR -->
    <div class="absolute top-24 right-4 bottom-10 w-80 z-[1000] flex flex-col pointer-events-none">
        <div class="glass-panel rounded-2xl shadow-2xl flex flex-col max-h-full pointer-events-auto overflow-hidden">
            <div class="p-5 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                <h2 id="sidebar-title" class="font-bold text-xl text-slate-800">Lade Daten...</h2>
                <p id="sidebar-desc" class="text-sm text-slate-500 mt-1 font-medium">Bitte warten</p>
            </div>
            <div id="sidebar-content" class="overflow-y-auto p-2 space-y-2 bg-white/60 flex-1"></div>
        </div>
    </div>

    <div id="map"></div>
    <div class="absolute bottom-0 left-0 z-[1000] bg-white/90 backdrop-blur px-4 py-1.5 text-[11px] font-medium text-slate-500 rounded-tr-xl border-t border-r border-slate-200 shadow-sm">© 2025 Atlas Saar | Daten: Stat. Amt Saarland</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        let currentViewMode = 'details', currentMode = 'history', currentYear = 2024;
        function closeWelcome() { document.getElementById('welcome-overlay').classList.add('hidden-overlay'); setTimeout(() => map.flyTo([49.38, 6.98], 10.5, { duration: 2.5 }), 300); }

        // --- GRENZDATEN (Fallback, stark vereinfacht um Code-Größe zu sparen) ---
        const fallbackBorder = [[49.62,6.91],[49.64,7.04],[49.58,7.15],[49.55,7.23],[49.45,7.39],[49.35,7.43],[49.22,7.31],[49.12,7.18],[49.12,7.05],[49.16,6.96],[49.16,6.79],[49.23,6.69],[49.34,6.66],[49.42,6.59],[49.47,6.36],[49.55,6.49],[49.62,6.91]];

        const saarlandPopData = {1926:769300,1927:772700,1930:794500,1935:814576,1939:824000,1946:857630,1950:948716,1955:996238,1960:1060493,1965:1127354,1970:1121300,1974:1103255,1980:1066299,1985:1045936,1990:1072963,1995:1084370,2000:1068703,2005:1050293,2010:1017567,2015:995597,2020:983991,2024:1012141};
        const overviewLines = { mining: {name:"Kohlegürtel",color:"#ef4444",path:[[49.180,6.800],[49.250,6.850],[49.290,6.980],[49.310,7.060],[49.350,7.120],[49.370,7.250]]}, steel: {name:"Stahlachse",color:"#475569",path:[[49.350,6.740],[49.250,6.840],[49.240,6.940],[49.220,7.030],[49.280,7.120],[49.345,7.180],[49.325,7.335]]}};

        // --- DATEN (Bilder & Urheber aktualisiert aus PDF) ---
        const historyData={
            mines:[
                {id:"m1",name:"Bergwerk Saar / Ensdorf",coords:[49.3188,6.7780],type:"Kohle",period:"1833-2012",desc:"Das letzte aktive Bergwerk des Saarlandes. Bekannt für das 'Saarpolygon'.", img:"img/ensdorf.jpg", copyright:"Foto: Josef Dernbercher"},
                {id:"m2",name:"Grube Göttelborn",coords:[49.3548,7.0335],type:"Kohle",period:"1887-2000",desc:"Einst eine der modernsten Gruben Europas, bekannt als der 'Weiße Riese'.", img:"img/goettelborn.jpg", copyright:"Foto: Mark Scheider"},
                {id:"m3",name:"Grube Reden",coords:[49.3493,7.1132],type:"Kohle",period:"1846-1995",desc:"Traditionsreiche Anlage, heute 'Gondwana'.", img:"img/reden.jpg", copyright:"Foto: Alain Meier"},
                {id:"m4",name:"Grube Camphausen",coords:[49.3065,7.0074],type:"Kohle",period:"1871-1990",desc:"Architektonisch herausragend durch den Hammerkopfturm.", img:"img/camphausen.jpg", copyright:"Foto: Flocci Nivis"},
                {id:"m5",name:"Grube Luisenthal",coords:[49.2477,6.8938],type:"Kohle",period:"1820-2005",desc:"Tiefstes Bergwerk der Saar. Traurige Bekanntheit durch das Unglück 1962.", img:"img/luisenthal.jpg", copyright:"Foto: LoKiLeCh"},
                {id:"m6",name:"Grube Warndt",coords:[49.1864,6.8097],type:"Kohle",period:"1963-2005",desc:"Das jüngste Großbergwerk des Reviers im Warndt.", img:"img/warndt.jpg", copyright:"Foto: Ducky88"},
                {id:"m7",name:"Grube Velsen",coords:[49.2219,6.8363],type:"Kohle",period:"1899-2005",desc:"Bekannt für ihre Kaffeeküche. Heute Erlebnisbergwerk.", img:"img/velsen.jpg", copyright:"Foto: Unbekannt"},
                {id:"m8",name:"Grube Itzenplitz",coords:[49.3542,7.0869],type:"Kohle",period:"1856-1960",desc:"Besitzt das älteste erhaltene Fördergerüst des Saarlandes.", img:"img/itzenplitz.jpg", copyright:"Foto: Elmar Ersch"},
                {id:"m9",name:"Grube Dechen",coords:[49.3378,7.1722],type:"Kohle",period:"1854-1968",desc:"Essentiell für die Koks-Versorgung der Neunkircher Hütte.", img:"img/dechen.jpg", copyright:"Foto: Zecke64"},
                {id:"m10",name:"Grube Heinitz",coords:[49.3300,7.1300],type:"Kohle",period:"1847-1964",desc:"Traditionsreiche Staatsgrube bei Neunkirchen.", img:"img/heinitz.jpg", copyright:"Foto: Gripweed"},
                {id:"m11",name:"Grube König",coords:[49.3450,7.1750],type:"Kohle",period:"1820-1968",desc:"Zentral in Neunkirchen gelegen, prägte die Stadt.", img:"img/koenig.jpg", copyright:"Foto: Carl Heinrich Jacobi"},
                {id:"m12",name:"Grube Frankenholz",coords:[49.3702,7.2405],type:"Kohle",period:"1879-1959",desc:"Einst tiefste Grube der Pfalz.", img:"img/frankenholz.jpg", copyright:"Foto: Unbekannt"},
                {id:"m13",name:"Grube St. Ingbert",coords:[49.2830,7.1180],type:"Kohle",period:"1852-1959",desc:"Rischbachstollen (Besucherbergwerk).", img:"img/inbert.jpg", copyright:"Foto: Christian Bohr"},
                {id:"m14",name:"Grube Maybach",coords:[49.3205,7.0632],type:"Kohle",period:"1873-1964",desc:"Bekannt für den Marie-Juchacz-Schacht.", img:"img/maybach.jpg", copyright:"Foto: Unbekannt"},
                {id:"m15",name:"Grube Viktoria",coords:[49.2927,6.8882],type:"Kohle",period:"1866-1963",desc:"Die 'Köllertal-Metropole'.", img:"img/viktoria.jpg", copyright:"Foto: Kallewirsch"},
                {id:"m16",name:"Grube Von der Heydt",coords:[49.2688,6.9575],type:"Kohle",period:"1850-1965",desc:"Idyllische Waldgrube mit eigener Arbeitersiedlung.", img:"img/heydt.jpg", copyright:"Foto: Unbekannt"},
                {id:"m17",name:"Grube Jägersfreude",coords:[49.2610,7.0050],type:"Kohle",period:"1856-1968",desc:"Direkt an der Bahnlinie Saarbrücken.", img:"img/jaegersfreude.jpg", copyright:"Foto: Flocci Nivis"},
                {id:"m18",name:"Grube Kohlwald",coords:[49.3680,7.1980],type:"Kohle",period:"1842-1966",desc:"Grenzgrube bei Wiebelskirchen.", img:"img/kohlwald.jpg", copyright:"Foto: Georg Diancourt"},
                {id:"m19",name:"Grube Hirschbach",coords:[49.2850,7.0450],type:"Kohle",period:"1816-1950",desc:"Eine der ältesten Gruben in Dudweiler.", img:"img/hirschbach.jpg", copyright:"Foto: Zecke64"},
                {id:"m26",name:"Grube Altenwald",coords:[49.3100,7.0800],type:"Kohle",period:"1851-1932",desc:"Sulzbach. Die Kohleförderung endete 1932.", img:"img/altenwald.jpg", copyright:"Foto: Unbekannt"},
                {id:"m29",name:"Grube Reisbach",coords:[49.3800,6.9000],type:"Kohle",period:"1962-2000",desc:"Privatgrube Dr. Arnold Schäfer.", img:"img/reisbach.jpg", copyright:"Foto: Flocci Nivis"},
                {id:"m30",name:"Grube Hostenbach",coords:[49.2600,6.7800],type:"Kohle",period:"1750-1932",desc:"Wadgassen. Eine der ältesten Gruben des Landes.", img:"img/hostenbach.jpg", copyright:"Foto: Zecke64"},
                {id:"m31",name:"Grube Mellin",coords:[49.3050,7.0650],type:"Kohle",period:"1856-1932",desc:"Sulzbach. Bekannt für das neugotische Ensemble.", img:"img/mellin.jpg", copyright:"Foto: Flocci Nivis"}
            ],
            steel:[
                {id:"s1",name:"Völklinger Hütte",coords:[49.2485,6.8442],type:"Stahl",period:"UNESCO",desc:"Weltkulturerbe seit 1994.", img:"img/voelklingen.jpg", copyright:"Foto: TeKaBe"},
                {id:"s2",name:"Dillinger Hütte",coords:[49.3480,6.7450],type:"Stahl",period:"Aktiv",desc:"Grobblech-Spezialist, gegr. 1685.", img:"img/dillingen.jpg", copyright:"Foto: Borchel"},
                {id:"s3",name:"Neunkircher Eisenwerk",coords:[49.3455,7.1780],type:"Stahl",period:"1593-1982",desc:"Dominierte das Stadtbild Neunkirchens.", img:"img/neunkirchen.jpg", copyright:"Foto: Pierre Lemoine"},
                {id:"s4",name:"Halberger Hütte",coords:[49.2180,7.0300],type:"Stahl",period:"Aktiv",desc:"Brebach. Gussrohre und Motorteile.", img:"img/halberg.jpg", copyright:"Foto: AnRo0002"},
                {id:"s5",name:"Burbacher Hütte",coords:[49.2420,6.9350],type:"Stahl",period:"Aktiv",desc:"Saarbrücken-Burbach. Drahtstraße.", img:"img/burbach.jpg", copyright:"Foto: NobbiP"},
                {id:"s6",name:"Alte Schmelz",coords:[49.2750,7.1050],type:"Eisen",period:"1733-1991",desc:"Industriedenkmal St. Ingbert.", img:"img/schmelz.jpg", copyright:"Foto: Conny Liegl"},
                {id:"s7",name:"Eisenwerk Homburg",coords:[49.3250,7.3350],type:"Eisen",period:"19. Jh.",desc:"Wichtiger Standort für die pfälzisch-saarländische Eisenindustrie.", img:"img/homburg.jpg", copyright:"Foto: Bezirksamt rentamt"},
                {id:"s8",name:"Mariahütte",coords:[49.6050,6.9650],type:"Eisen",period:"ab 17. Jh.",desc:"Eine der ältesten Hütten im Hochwald.", img:"img/mariahuette.jpg", copyright:"Foto: Leiflive"},
                {id:"s10",name:"Geislauterner Eisenwerk",coords:[49.2350,6.8300],type:"Eisen",period:"1585-1875",desc:"Wiege der saarländischen Eisenindustrie.", img:"img/geislautern.jpg", copyright:"Foto: Zecke64"},
                {id:"s11",name:"Eisenwerk Bettingen",coords:[49.4350,6.8600],type:"Eisen",period:"1686-1868",desc:"Namensgeber für den Ort 'Schmelz'.", img:"img/schmelz.jpg", copyright:"Foto: Conny Liegl"},
                {id:"s21",name:"Hüttigweiler",coords:[49.3880,7.0800],type:"Eisen",period:"Mittelalter",desc:"Historischer Standort in Illingen.", img:"", copyright:""}
            ]
        };

        const urbanDataRaw = [
            { name: "Saarbrücken", coords: [49.2333, 7.0000], desc: "Landeshauptstadt", history: { 1926:95000, 1950:110000, 1970:125000, 1974:205000, 1990:191000, 2024:181900 }},
            { name: "Neunkirchen", coords: [49.3450, 7.1780], desc: "Hüttenstadt", history: { 1926:38000, 1950:43000, 1965:48000, 1974:55000, 1990:51000, 2024:46900 }},
            { name: "Völklingen", coords: [49.2500, 6.8500], desc: "Stahlstandort", history: { 1926:30000, 1950:39000, 1965:44000, 1974:48000, 1990:44000, 2024:40000 }},
            { name: "Sulzbach", coords: [49.3000, 7.0600], desc: "Bergbauzentrum", history: { 1926:20000, 1950:23000, 1960:25000, 1974:21000, 1990:19000, 2024:16000 }},
            { name: "Friedrichsthal", coords: [49.3250, 7.0950], desc: "Bergbau", history: { 1926:13000, 1950:15000, 1960:16000, 1974:14000, 1990:12000, 2024:10000 }},
            { name: "Saarlouis", coords: [49.3167, 6.7500], desc: "Festungsstadt", history: { 1926:16000, 1950:30000, 1970:36000, 1974:40000, 1990:38000, 2024:34500 }},
            { name: "Homburg", coords: [49.3200, 7.3400], desc: "Heute Uni & Industrie", history: { 1926:12000, 1950:31000, 1970:35000, 1974:44000, 1990:45000, 2024:42000 }},
            { name: "St. Ingbert", coords: [49.2800, 7.1200], desc: "Biosphäre", history: { 1926:20000, 1950:27000, 1970:29000, 1974:40000, 1990:39000, 2024:35500 }},
            { name: "Merzig", coords: [49.4419, 6.6378], desc: "Kreisstadt", history: { 1926:10000, 1950:14000, 1970:16000, 1974:28000, 1990:31000, 2024:30000 }},
            { name: "St. Wendel", coords: [49.4667, 7.1667], desc: "Wirtschaftszentrum Nord", history: { 1926:8000, 1950:11000, 1970:12000, 1974:27000, 1990:27000, 2024:25500 }},
            { name: "Dillingen", coords: [49.3500, 6.7333], desc: "Hüttenstadt", history: { 1926:9000, 1950:18000, 1965:21000, 1974:24000, 1990:22000, 2024:20000 }},
            { name: "Wadern", coords: [49.539, 6.893], desc: "Mittelzentrum Hochwald", history: { 1926:12000, 1950:13500, 1974:15000, 1990:15800, 2024:15700 }},
            { name: "Losheim am See", coords: [49.510, 6.745], desc: "Tourismus & Gewerbe", history: { 1926:11000, 1950:13000, 1974:15000, 1990:16000, 2024:16000 }},
            { name: "Nonnweiler", coords: [49.606, 7.005], desc: "Nationalpark-Gemeinde", history: { 1926:7000, 1950:8000, 1974:9500, 1990:9200, 2024:8500 }}
        ];

        const transportData = [
            {name:"RE 1",desc:"Trier - SB - Homburg",color:"#db2777",path:[[49.600,6.550],[49.490,6.590],[49.441,6.637],[49.350,6.733],[49.316,6.750],[49.250,6.850],[49.233,7.000],[49.280,7.120],[49.320,7.340],[49.380,7.350]]},
            {name:"RE 3",desc:"SB - NK - Mainz",color:"#0ea5e9",path:[[49.233,7.000],[49.300,7.060],[49.345,7.178],[49.405,7.165],[49.466,7.166],[49.580,7.150],[49.630,7.180]]},
            {name:"RB 68",desc:"SB - St. Ingbert - Zweibrücken",color:"#2563eb",path:[[49.233,7.000],[49.280,7.120],[49.250,7.250],[49.240,7.350]]},
            {name:"RB 72",desc:"SB - Illingen - Lebach",color:"#8b5cf6",path:[[49.233,7.000],[49.325,7.050],[49.375,7.050],[49.410,6.910]]},
            {name:"RB 77",desc:"Dillingen - Niedaltdorf",color:"#64748b",path:[[49.350,6.733],[49.350,6.600]]},
            {name:"Saarbahn",desc:"Lebach - SB - Saargemünd",color:"#eab308",path:[[49.410,6.910],[49.340,6.930],[49.310,6.940],[49.233,7.000],[49.218,7.030],[49.155,7.035],[49.110,7.080]]}
        ];

        const map = L.map('map', { zoomControl: false }).setView([49.38, 6.95], 10);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 20}).addTo(map);
        let currentLayers = L.layerGroup().addTo(map);
        let borderLayer = L.layerGroup().addTo(map);

        // GEOJSON LOADER
        fetch('export.geojson')
            .then(r => r.json())
            .then(data => {
                const saarland = data.features.find(f => f.properties.name === 'Saarland');
                L.geoJSON(saarland || data, {
                    style: { color: '#64748b', weight: 2, fill: false, dashArray: '6, 6', opacity: 0.75 }
                }).addTo(borderLayer);
            })
            .catch(() => {
                L.polygon(fallbackBorder, {color: '#64748b', weight: 2, fill: false, dashArray: '6, 6', opacity: 0.75}).addTo(borderLayer);
            });

        function clearMap() { currentLayers.clearLayers(); document.getElementById('sidebar-content').innerHTML = ''; }

        function getPopForYear(history, year) {
            const years = Object.keys(history).map(Number).sort((a,b)=>a-b);
            if(year<=years[0]) return history[years[0]]; if(year>=years[years.length-1]) return history[years[years.length-1]];
            let prev=years[0], next=years[years.length-1];
            for(let y of years) { if(y<=year) prev=y; if(y>year) { next=y; break; } }
            const fraction = (year-prev)/(next-prev);
            return Math.round(history[prev] + fraction * (history[next]-history[prev]));
        }

        function updateUrbanMap(val) {
            currentYear = parseInt(val);
            document.getElementById('yearDisplay').innerText = currentYear;
            const totalPop = getPopForYear(saarlandPopData, currentYear);
            document.getElementById('total-pop-value').innerText = totalPop.toLocaleString();
            document.getElementById('total-pop-year').innerText = "Jahr: " + currentYear;
            
            const badge = document.getElementById('reform-badge');
            if (currentYear >= 1973 && currentYear <= 1975) { badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
            
            if (currentMode === 'urban') { clearMap(); renderUrban(); }
        }

        function expandSidebarItem(id) {
            const contentDiv = document.getElementById(`details-${id}`);
            if (contentDiv) {
                document.querySelectorAll('.details-content').forEach(el => { if(el.id !== `details-${id}`) el.classList.remove('open'); });
                contentDiv.classList.add('open');
                contentDiv.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function createExpandableListItem(item, iconClass, colorClass, onClickMarker) {
            const div = document.createElement('div');
            div.className = `group rounded-xl bg-white border border-slate-100 hover:border-slate-300 shadow-sm mb-2 overflow-hidden`;
            const dotColor = colorClass.replace('border-', 'bg-').replace('text-', 'bg-');
            
            let badgeHtml = '';
            if (item.type) {
                let badgeColor = "bg-slate-100 text-slate-600 border-slate-200";
                if (item.type === "Kohle") badgeColor = "bg-red-50 text-red-600 border-red-100";
                else if (item.type === "Eisen" || item.type === "Kupfer" || item.type === "Kalk") badgeColor = "bg-orange-50 text-orange-600 border-orange-100";
                else if (item.type === "Stahl") badgeColor = "bg-slate-50 text-slate-600 border-slate-200";
                badgeHtml = `<span class="${badgeColor} text-[10px] font-bold px-2 py-0.5 rounded border ml-2">${item.type}</span>`;
            }

            let imgHtml = '';
            if(item.img && item.img !== "") {
                imgHtml = `<img src="${item.img}" alt="${item.name}" class="location-img rounded-lg mb-2 shadow-sm" onerror="this.style.display='none'">`;
                if(item.copyright) { imgHtml += `<div class="copyright-text">${item.copyright}</div>`; }
            }

            div.innerHTML = `
                <div class="p-3.5 flex items-center gap-3.5 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('open'); ${onClickMarker?`(${onClickMarker})()`:''}">
                    <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-xl text-slate-500"><i class="${iconClass}"></i></div>
                    <div class="flex-1"><div class="font-bold text-sm text-slate-800 flex items-center">${item.name} <span class="md:hidden">${badgeHtml}</span></div><div class="text-xs text-slate-500 font-medium">${item.period}</div></div><div class="w-2 h-2 rounded-full ${dotColor}"></div>
                </div>
                <div id="details-${item.id}" class="details-content bg-slate-50 text-xs text-slate-600 px-4">
                    <div class="py-3 border-t border-slate-200">
                        ${imgHtml}
                        <div class="mb-2 hidden md:block">${badgeHtml}</div>
                        <p class="leading-relaxed text-justify">${item.desc}</p>
                    </div>
                </div>`;
            return div;
        }

        function createSimpleListItem(title, subtitle, color, onClick) {
            const div = document.createElement('div');
            div.className = "p-3 mb-2 bg-white rounded-lg border-l-4 shadow-sm text-sm cursor-pointer hover:bg-slate-50";
            div.style.borderLeftColor = color;
            div.innerHTML = `<b>${title}</b><br><span class="text-xs text-slate-500">${subtitle}</span>`;
            div.onclick = onClick;
            return div;
        }

        const getMineIcon = (c) => L.divIcon({className: 'custom-div-icon', html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${c}" stroke="white" stroke-width="1.5" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter">G</text></svg>`, iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-32]});
        const getOreIcon = (c) => L.divIcon({className: 'custom-div-icon', html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${c}" stroke="white" stroke-width="1.5" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter">E</text></svg>`, iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-32]});
        const getSteelIcon = (c) => L.divIcon({className: 'custom-div-icon', html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${c}" stroke="white" stroke-width="1.5" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter">H</text></svg>`, iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-32]});

        function addOverviewLines(containerList) {
            const miningLine = L.polyline(overviewLines.mining.path, { color: overviewLines.mining.color, weight: 20, opacity: 0.6, lineCap: 'round', lineJoin: 'round', interactive: false }).addTo(currentLayers);
            const steelLine = L.polyline(overviewLines.steel.path, { color: overviewLines.steel.color, weight: 20, opacity: 0.6, lineCap: 'round', lineJoin: 'round', interactive: false }).addTo(currentLayers);
            
            if (containerList) { 
                const overlayInfo = document.createElement('div'); 
                overlayInfo.className = "mt-4 p-2 border-t border-slate-200 text-[10px] text-slate-400 text-center uppercase tracking-wider"; 
                overlayInfo.innerHTML = "Industrieachsen eingeblendet"; 
                containerList.appendChild(overlayInfo); 
                containerList.appendChild(createSimpleListItem("Kohlegürtel", "Historische Hauptachse", "#ef4444", () => map.fitBounds(miningLine.getBounds())));
                containerList.appendChild(createSimpleListItem("Stahlachse", "Industrielle Tallagen", "#475569", () => map.fitBounds(steelLine.getBounds())));
            }
        }

        function renderLegend(mode) {
            const container = document.getElementById('legend-content');
            const panel = document.getElementById('legend-panel');
            let html = '';
            if (mode === 'transport') { panel.classList.add('hidden'); panel.classList.remove('md:block'); return; }
            panel.classList.remove('hidden'); panel.classList.add('md:block');
            const borderLegend = `<div class="flex items-center gap-2.5 mt-2 pt-2 border-t border-slate-100"><span class="w-6 h-0 border-t-2 border-dashed border-slate-400"></span><span class="text-slate-500">Landesgrenze</span></div>`;

            if (mode === 'history') {
                html = `<div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-red-500 border border-white shadow-sm"></span><span>Steinkohlebergwerk</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-orange-500 border border-white shadow-sm"></span><span>Erz-/Kalkbergwerk</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-slate-600 border border-white shadow-sm"></span><span>Stahl-/Hüttenwerk</span></div>`;
                if (currentViewMode === 'overview') {
                     html += `<div class="mt-2 pt-2 border-t border-slate-100"><div class="flex items-center gap-2.5"><span class="w-4 h-1 bg-red-500 rounded-full opacity-50"></span><span class="text-[10px] text-slate-500">Kohlegürtel (in Übersicht)</span></div><div class="flex items-center gap-2.5"><span class="w-4 h-1 bg-slate-600 rounded-full opacity-50"></span><span class="text-[10px] text-slate-500">Stahlachse (in Übersicht)</span></div></div>`;
                }
            } else if (mode === 'urban') {
                html = `<div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-purple-700 opacity-60"></span><span>> 100k EW</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-purple-500 opacity-60"></span><span>> 30k EW</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-purple-300 opacity-60"></span><span>< 30k EW</span></div>`;
                if (currentViewMode === 'overview') {
                     html += `<div class="mt-2 pt-2 border-t border-slate-100"><div class="flex items-center gap-2.5"><span class="w-4 h-1 bg-red-500 rounded-full opacity-50"></span><span class="text-[10px] text-slate-500">Kohlegürtel (in Übersicht)</span></div><div class="flex items-center gap-2.5"><span class="w-4 h-1 bg-slate-600 rounded-full opacity-50"></span><span class="text-[10px] text-slate-500">Stahlachse (in Übersicht)</span></div></div>`;
                }
            }
            container.innerHTML = html + borderLegend;
        }

        function renderHistory() {
            document.getElementById('sidebar-title').innerText = "Berg- und Stahlbau";
            document.getElementById('sidebar-desc').innerText = "Kohle, Erz & Stahl";
            const list = document.getElementById('sidebar-content');
            
            if(currentViewMode === 'overview') {
                L.polyline(overviewLines.mining.path, {color: "#ef4444", weight: 20, opacity: 0.6}).addTo(currentLayers).bindTooltip("Kohlegürtel", {sticky: true});
                L.polyline(overviewLines.steel.path, {color: "#475569", weight: 20, opacity: 0.6}).addTo(currentLayers).bindTooltip("Stahlachse", {sticky: true});
                list.innerHTML = `<div class="p-4 bg-slate-50 text-slate-800 text-xs rounded-xl border border-slate-200"><b>Strukturanalyse:</b> Die Linien zeigen die historischen Industrieachsen.</div>`;
                list.appendChild(createSimpleListItem("Kohlegürtel", "Historische Hauptachse", "#ef4444", () => map.fitBounds(L.polyline(overviewLines.mining.path).getBounds())));
                list.appendChild(createSimpleListItem("Stahlachse", "Industrielle Tallagen", "#475569", () => map.fitBounds(L.polyline(overviewLines.steel.path).getBounds())));
            } else {
                historyData.mines.forEach(m => {
                    let icon = m.type === "Kohle" ? getMineIcon('#ef4444') : getOreIcon('#f97316');
                    let color = m.type === "Kohle" ? "bg-red-500" : "bg-orange-500";
                    const marker = L.marker(m.coords, {icon: icon}).addTo(currentLayers);

                    let badgeColor = m.type === "Kohle" ? "bg-red-50 text-red-600 border-red-100" : "bg-orange-50 text-orange-600 border-orange-100";
                    let imgHtml = '';
                    if(m.img && m.img !== "") {
                         imgHtml = `<div class="h-32 w-full overflow-hidden bg-gray-100 mb-2 relative"><img src="${m.img}" class="w-full h-full object-cover" onerror="this.style.display='none'"></div>`;
                         if(m.copyright) { imgHtml += `<div style="font-size:9px; color:#999; text-align:right; margin-top:-15px; margin-right:5px; position:relative; z-index:10; text-shadow:0 1px 2px white;">${m.copyright}</div>`; }
                    }

                    marker.bindPopup(`
                        <div class="w-full bg-white p-3">
                            ${imgHtml}
                            <div class="flex justify-between items-start">
                                <b class="${m.type==='Kohle'?'text-red-600':'text-orange-600'} block text-sm">${m.name}</b>
                                <span class="${badgeColor} text-[9px] font-bold px-1.5 py-0.5 rounded border">${m.type}</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-1 mb-3">${m.period}</div>
                            <button onclick="expandSidebarItem('${m.id}')" class="w-full text-center bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-bold py-1.5 rounded transition-colors">Weitere Informationen →</button>
                        </div>
                    `);
                    list.appendChild(createExpandableListItem(m, m.type === "Kohle" ? "ph-pick-axe" : "ph-mountains", color, () => { map.flyTo(m.coords, 13); marker.openPopup(); }));
                });
                historyData.steel.forEach(s => {
                    const marker = L.marker(s.coords, {icon: getSteelIcon('#475569')}).addTo(currentLayers);
                    
                    let badgeColor = "bg-slate-50 text-slate-600 border-slate-200";
                    let imgHtml = '';
                    if(s.img && s.img !== "") {
                         imgHtml = `<div class="h-32 w-full overflow-hidden bg-gray-100 mb-2 relative"><img src="${s.img}" class="w-full h-full object-cover" onerror="this.style.display='none'"></div>`;
                         if(s.copyright) { imgHtml += `<div style="font-size:9px; color:#999; text-align:right; margin-top:-15px; margin-right:5px; position:relative; z-index:10; text-shadow:0 1px 2px white;">${s.copyright}</div>`; }
                    }

                    marker.bindPopup(`
                        <div class="w-full bg-white p-3">
                            ${imgHtml}
                            <div class="flex justify-between items-start">
                                <b class="text-slate-700 block text-sm">${s.name}</b>
                                <span class="${badgeColor} text-[9px] font-bold px-1.5 py-0.5 rounded border">${s.type}</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-1 mb-3">${s.period}</div>
                            <button onclick="expandSidebarItem('${s.id}')" class="w-full text-center bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-bold py-1.5 rounded transition-colors">Weitere Informationen →</button>
                        </div>
                    `);
                    list.appendChild(createExpandableListItem(s, "ph-factory", "bg-slate-600", () => { map.flyTo(s.coords, 13); marker.openPopup(); }));
                });
            }
        }

        function renderUrban() {
            document.getElementById('sidebar-title').innerText = "Bevölkerung";
            document.getElementById('sidebar-desc').innerText = "1926 - 2024";
            const list = document.getElementById('sidebar-content');
            document.getElementById('total-pop-display').classList.remove('hidden');
            
            if(currentViewMode === 'overview') {
                L.polyline(overviewLines.mining.path, {color: "#ef4444", weight: 20, opacity: 0.6}).addTo(currentLayers);
                L.polyline(overviewLines.steel.path, {color: "#475569", weight: 20, opacity: 0.6}).addTo(currentLayers);
                list.innerHTML = `<div class="p-4 bg-blue-50 text-blue-900 text-xs rounded-xl border border-blue-100 mb-2"><b>Korrelation:</b> Bevölkerungsschwerpunkte liegen auf den Industrieachsen.</div>`;
                addOverviewLines(list);
            }

            urbanDataRaw.forEach(city => {
                const pop = getPopForYear(city.history, currentYear);
                const radius = Math.sqrt(pop) * 20; 
                const color = pop > 100000 ? '#7e22ce' : (pop > 30000 ? '#a855f7' : '#d8b4fe');
                const circle = L.circle(city.coords, {color, fillColor: color, fillOpacity: 0.5, radius, weight: 1}).addTo(currentLayers);
                circle.bindPopup(`<b>${city.name}</b><br>${pop.toLocaleString()} EW`);
                const item = document.createElement('div');
                item.className = "p-3 mb-2 bg-white rounded-lg border-l-4 border-purple-500 shadow-sm text-sm cursor-pointer flex justify-between";
                item.innerHTML = `<span><b>${city.name}</b></span><span>${pop.toLocaleString()}</span>`;
                item.onclick = () => { map.flyTo(city.coords, 13); circle.openPopup(); };
                list.appendChild(item);
            });
        }

        function renderTransport() {
            document.getElementById('sidebar-title').innerText = "Schienennetz";
            document.getElementById('sidebar-desc').innerText = "Aktive Linien";
            const list = document.getElementById('sidebar-content');
            if(currentViewMode === 'overview') {
                 L.polyline(overviewLines.mining.path, {color: "#ef4444", weight: 20, opacity: 0.6}).addTo(currentLayers);
                 L.polyline(overviewLines.steel.path, {color: "#475569", weight: 20, opacity: 0.6}).addTo(currentLayers);
                 list.innerHTML = `<div class="p-4 bg-blue-50 text-blue-900 text-xs rounded-xl border border-blue-100"><b>Historische Pfade:</b> Das moderne Netz folgt den alten Transportwegen.</div>`;
            }
            transportData.forEach(r => {
                const poly = L.polyline(r.path, {color: r.color, weight: 4}).addTo(currentLayers);
                list.appendChild(createSimpleListItem(r.name, r.desc, r.color, () => map.fitBounds(poly.getBounds())));
            });
        }

        function setViewMode(v) { 
            currentViewMode = v; 
            
            const detailsBtn = document.getElementById('view-details');
            const overviewBtn = document.getElementById('view-overview');
            
            if (v === 'details') {
                detailsBtn.className = "px-3 py-1.5 rounded-md text-xs font-bold bg-slate-800 text-white shadow transition-all flex items-center gap-1";
                overviewBtn.className = "px-3 py-1.5 rounded-md text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all flex items-center gap-1";
            } else {
                detailsBtn.className = "px-3 py-1.5 rounded-md text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all flex items-center gap-1";
                overviewBtn.className = "px-3 py-1.5 rounded-md text-xs font-bold bg-slate-800 text-white shadow transition-all flex items-center gap-1";
            }

            if (currentMode === 'urban') {
                updateUrbanMap(document.getElementById('yearSlider').value);
            } else {
                clearMap();
                if (currentMode === 'history') renderHistory();
                if (currentMode === 'transport') renderTransport();
            }
            
            renderLegend(currentMode);
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-600', 'bg-transparent'); });
            document.getElementById(`btn-${mode}`).classList.add('active');
            document.getElementById(`btn-${mode}`).classList.remove('text-slate-600', 'bg-transparent');

            const viewCtrl = document.getElementById('view-controls');
            const timeSlider = document.getElementById('time-slider-container');
            const popDisplay = document.getElementById('total-pop-display');
            
            viewCtrl.classList.remove('hidden'); 
            timeSlider.classList.add('hidden');
            popDisplay.classList.add('hidden');

            if(mode === 'urban') { 
                viewCtrl.classList.remove('hidden'); 
                timeSlider.classList.remove('hidden'); 
                popDisplay.classList.remove('hidden');
                if(!currentViewMode) currentViewMode = 'details';
                setViewMode(currentViewMode); // This updates map content
            } else {
                renderLegend(mode);
                clearMap();
                if (mode === 'history') renderHistory();
                if (mode === 'transport') renderTransport();
            }
        }

        setTimeout(() => { switchMode('history'); }, 100);
    </script>
</body>
</html>
