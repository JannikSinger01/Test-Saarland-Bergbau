<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Saar: Gestern & Heute</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* BASIS DESIGN */
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            background-color: #f8fafc;
        }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* GLASSMORPHISMUS */
        .glass-panel {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* TAB BUTTONS */
        .tab-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tab-btn.active {
            background-color: #0f172a; /* Slate 900 */
            color: white;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
        }
        
        /* SLIDER STYLING */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #0f172a;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* POPUP STYLING */
        .leaflet-popup-content-wrapper { 
            border-radius: 12px; 
            padding: 0; 
            overflow: hidden; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); 
        }
        .leaflet-popup-content { margin: 0 !important; width: 260px !important; }
        .leaflet-container a.leaflet-popup-close-button {
            color: #64748b;
            padding: 8px;
            z-index: 10;
        }

        /* ANIMATIONEN */
        .details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .details-content.open {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }
        #welcome-overlay { transition: opacity 0.5s ease, visibility 0.5s; }
        #welcome-overlay.hidden-overlay { opacity: 0; visibility: hidden; pointer-events: none; }
        .custom-div-icon { background: transparent; border: none; }
        
        .reform-alert { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="relative h-screen w-screen text-slate-800">

    <!-- 1. WELCOME OVERLAY -->
    <div id="welcome-overlay" class="absolute inset-0 z-[9999] bg-slate-900/95 backdrop-blur-md flex items-center justify-center text-white p-6">
        <div class="max-w-3xl text-center space-y-8 fade-in-up">
            <div class="inline-block p-4 bg-white/5 rounded-full mb-2 border border-white/10">
                <i class="ph ph-map-trifold text-5xl text-blue-400"></i>
            </div>
            <div class="space-y-4">
                <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight text-white">Atlas Saar</h1>
                <div class="h-1 w-24 bg-blue-500 mx-auto rounded-full opacity-80"></div>
            </div>
            <p class="text-xl md:text-2xl text-slate-300 leading-relaxed font-light max-w-2xl mx-auto">
                Wie hat die Ära der <span class="text-red-400 font-medium">Schwerindustrie</span> das Gesicht des <span class="text-blue-400 font-medium">heutigen Saarlandes</span> geformt?
            </p>
            <button onclick="closeWelcome()" class="mt-10 px-10 py-4 bg-white text-slate-900 rounded-full font-bold text-lg shadow-lg hover:bg-blue-50 hover:scale-105 transition-all transform flex items-center gap-2 mx-auto">
                <span>Karte erkunden</span>
                <i class="ph-bold ph-arrow-right"></i>
            </button>
            <div class="pt-8 text-xs text-slate-500 font-mono">
                Version 3.0 • Datenstand: 2025
            </div>
        </div>
    </div>

    <!-- 2. NAVIGATION (OBEN MITTE) -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] glass-panel rounded-full p-1.5 flex shadow-xl border border-white/40">
        <button onclick="switchMode('history')" id="btn-history" class="tab-btn active px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap">
            <i class="ph-fill ph-factory text-lg"></i> Berg- und Stahlbau
        </button>
        <button onclick="switchMode('urban')" id="btn-urban" class="tab-btn px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap">
            <i class="ph-fill ph-buildings text-lg"></i> Urbanisierung
        </button>
        <button onclick="switchMode('transport')" id="btn-transport" class="tab-btn px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap">
            <i class="ph-fill ph-train text-lg"></i> Verkehr
        </button>
    </div>

    <!-- 3. VIEW CONTROL (OBEN LINKS - Nur für History & Transport) -->
    <div id="view-controls" class="absolute top-24 left-4 z-[1000] glass-panel p-2 rounded-lg shadow-lg flex gap-2">
        <button onclick="setViewMode('details')" id="view-details" class="px-3 py-1.5 rounded-md text-xs font-bold bg-slate-800 text-white shadow transition-all flex items-center gap-1">
            <i class="ph-fill ph-map-pin"></i> Details
        </button>
        <button onclick="setViewMode('overview')" id="view-overview" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all flex items-center gap-1">
            <i class="ph-fill ph-wave-sine"></i> Übersicht
        </button>
    </div>

    <!-- 4. GESAMTBEVÖLKERUNG (OBEN LINKS - Nur für Urban) -->
    <div id="total-pop-display" class="absolute top-24 left-4 z-[1000] glass-panel p-4 rounded-xl shadow-lg hidden w-56 border-l-4 border-blue-500 transition-all">
        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Bevölkerung Saarland</div>
        <div class="text-3xl font-extrabold text-slate-800 tabular-nums" id="total-pop-value">---</div>
        <div class="text-[10px] text-slate-500 mt-1 text-right font-mono" id="total-pop-year">Jahr: 2024</div>
    </div>

    <!-- 5. TIME SLIDER (OBEN MITTE - Nur für Urban) -->
    <div id="time-slider-container" class="absolute top-24 left-1/2 transform -translate-x-1/2 z-[1000] glass-panel p-5 rounded-xl shadow-xl w-80 hidden">
        <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">
            <span>1926</span>
            <span>1950</span>
            <span>1974</span>
            <span>2024</span>
        </div>
        <input type="range" id="yearSlider" min="1926" max="2024" step="1" value="2024" oninput="updateUrbanMap(this.value)">
        
        <div class="flex justify-between items-end mt-2">
            <div class="font-bold text-2xl text-slate-800 tabular-nums" id="yearDisplay">2024</div>
            <div id="reform-badge" class="hidden text-[10px] font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded border border-amber-200 reform-alert flex items-center gap-1">
                <i class="ph-bold ph-warning"></i> Gebietsreform
            </div>
        </div>
    </div>

    <!-- 6. LEGENDE (UNTEN LINKS) -->
    <div id="legend-panel" class="absolute bottom-10 left-4 z-[1000] glass-panel p-4 rounded-xl shadow-lg max-w-[200px] transition-all duration-300 hidden md:block">
        <h3 class="font-bold text-[10px] text-slate-400 uppercase mb-2 tracking-widest">Legende</h3>
        <div id="legend-content" class="space-y-2.5 text-xs font-medium text-slate-700">
            <!-- Content wird dynamisch gefüllt -->
        </div>
    </div>

    <!-- 7. SIDEBAR (RECHTS) -->
    <div class="absolute top-24 right-4 bottom-10 w-80 z-[1000] flex flex-col pointer-events-none">
        <div class="glass-panel rounded-2xl shadow-2xl flex flex-col max-h-full pointer-events-auto overflow-hidden">
            <div class="p-5 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                <h2 id="sidebar-title" class="font-bold text-xl text-slate-800 tracking-tight">Lade Daten...</h2>
                <p id="sidebar-desc" class="text-sm text-slate-500 mt-1 font-medium">Bitte warten</p>
            </div>
            <div id="sidebar-content" class="overflow-y-auto p-2 space-y-2 bg-white/60 flex-1">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- MAP CONTAINER -->
    <div id="map"></div>

    <!-- FOOTER -->
    <div class="absolute bottom-0 left-0 z-[1000] bg-white/90 backdrop-blur px-4 py-1.5 text-[11px] font-medium text-slate-500 rounded-tr-xl border-t border-r border-slate-200 shadow-sm">
        © 2025 Atlas Saar | Daten: Stat. Amt Saarland
    </div>

    <!-- LEAFLET JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- KONFIGURATION ---
        let currentViewMode = 'details'; 
        let currentMode = 'history';
        let currentYear = 2024;

        // --- BEVÖLKERUNGSDATEN (Saarland Gesamt) ---
        // Quelle: Statistisches Amt Saarland, Fortschreibung 1926-2023
        const saarlandPopData = {
            1926: 769300, 1927: 772700, 1928: 778100, 1929: 785100, 1930: 794500,
            1931: 802500, 1932: 807700, 1933: 809900, 1934: 818013, 1935: 814576,
            1936: 820666, 1937: 820567, 1938: 823978, 1939: 824000, 1940: 812753,
            1941: 817228, 1942: 751705, 1943: 740000, 1944: 733545, 1945: 745612,
            1946: 857630, 1947: 887709, 1948: 914277, 1949: 935507, 1950: 948716,
            1951: 956549, 1952: 967928, 1953: 977758, 1954: 987650, 1955: 996238,
            1956: 1005173, 1957: 1019144, 1958: 1040146, 1959: 1040108, 1960: 1060493,
            1961: 1083012, 1962: 1096584, 1963: 1106157, 1964: 1117222, 1965: 1127354,
            1966: 1132127, 1967: 1131301, 1968: 1128902, 1969: 1127352, 1970: 1121300,
            1971: 1121990, 1972: 1118569, 1973: 1111878, 1974: 1103255, 1975: 1096333,
            1976: 1088961, 1977: 1081074, 1978: 1072953, 1979: 1068555, 1980: 1066299,
            1981: 1063033, 1982: 1057543, 1983: 1052794, 1984: 1050837, 1985: 1045936,
            1986: 1042135, 1987: 1054064, 1988: 1054142, 1989: 1064906, 1990: 1072963,
            1991: 1076879, 1992: 1084007, 1993: 1084522, 1994: 1084201, 1995: 1084370,
            1996: 1084184, 1997: 1080790, 1998: 1074223, 1999: 1071501, 2000: 1068703,
            2001: 1066470, 2002: 1064988, 2003: 1061376, 2004: 1056417, 2005: 1050293,
            2006: 1043167, 2007: 1036598, 2008: 1030324, 2009: 1022585, 2010: 1017567,
            2011: 997855, 2012: 994287, 2013: 990718, 2014: 989035, 2015: 995597,
            2016: 996651, 2017: 994187, 2018: 990509, 2019: 986887, 2020: 983991,
            2021: 982348, 2022: 992666, 2023: 994424, 2024: 1012141
        };

        // --- ÜBERSICHTSLINIEN ---
        const overviewLines = {
            mining: { name: "Kohlegürtel", color: "#ef4444", path: [[49.180, 6.800], [49.250, 6.850], [49.290, 6.980], [49.310, 7.060], [49.350, 7.120], [49.370, 7.250]] },
            steel: { name: "Stahlachse", color: "#475569", path: [[49.350, 6.740], [49.250, 6.840], [49.240, 6.940], [49.220, 7.030], [49.280, 7.120], [49.345, 7.180], [49.325, 7.335]] }
        };

        // --- HISTORISCHE DATEN (Minen & Stahl) ---
        const historyData = {
            mines: [
                { id: "m1", name: "Bergwerk Saar / Ensdorf", coords: [49.3188, 6.7780], type: "Kohle", period: "1833-2012", desc: "Das letzte aktive Bergwerk des Saarlandes (Halde Duhamel)." },
                { id: "m2", name: "Grube Göttelborn", coords: [49.3548, 7.0335], type: "Kohle", period: "1887-2000", desc: "Weißer Riese, Schacht IV. Höchstes Fördergerüst." },
                { id: "m3", name: "Grube Reden", coords: [49.3493, 7.1132], type: "Kohle", period: "1846-1995", desc: "Großbergwerk, heute Gondwana - Das Praehistorium." },
                { id: "m4", name: "Grube Camphausen", coords: [49.3065, 7.0074], type: "Kohle", period: "1871-1990", desc: "Backstein-Expressionismus (Hammerkopfturm)." },
                { id: "m5", name: "Grube Luisenthal", coords: [49.2477, 6.8938], type: "Kohle", period: "1820-2005", desc: "Tiefstes Bergwerk an der Saar (Völklingen)." },
                { id: "m6", name: "Grube Warndt", coords: [49.1864, 6.8097], type: "Kohle", period: "1963-2005", desc: "Modernstes Großbergwerk im Warndt." },
                { id: "m7", name: "Grube Velsen", coords: [49.2219, 6.8363], type: "Kohle", period: "1899-2005", desc: "Erlebnisbergwerk heute (Großrosseln)." },
                { id: "m8", name: "Grube Itzenplitz", coords: [49.3542, 7.0869], type: "Kohle", period: "1856-1960", desc: "Ältestes Fördergerüst im Heiligenwald." },
                { id: "m9", name: "Grube Dechen", coords: [49.3378, 7.1722], type: "Kohle", period: "1854-1968", desc: "Neunkirchen, Koks für die Hütte." },
                { id: "m10", name: "Grube Heinitz", coords: [49.3300, 7.1300], type: "Kohle", period: "1847-1964", desc: "Traditionsreiche Grube bei Neunkirchen." },
                { id: "m11", name: "Grube König", coords: [49.3450, 7.1750], type: "Kohle", period: "1820-1968", desc: "Zentral in Neunkirchen gelegen." },
                { id: "m12", name: "Grube Frankenholz", coords: [49.3702, 7.2405], type: "Kohle", period: "1879-1959", desc: "Einst tiefste Grube der Pfalz (Bexbach)." },
                { id: "m13", name: "Grube St. Ingbert", coords: [49.2830, 7.1180], type: "Kohle", period: "1852-1959", desc: "Rischbachstollen (Besucherbergwerk)." },
                { id: "m14", name: "Grube Maybach", coords: [49.3205, 7.0632], type: "Kohle", period: "1873-1964", desc: "Friedrichsthal (Marie-Juchacz-Schacht)." },
                { id: "m15", name: "Grube Viktoria", coords: [49.2927, 6.8882], type: "Kohle", period: "1866-1963", desc: "Püttlingen ('Köllertal-Metropole')." },
                { id: "m16", name: "Grube Von der Heydt", coords: [49.2688, 6.9575], type: "Kohle", period: "1850-1965", desc: "Waldgrube mit Siedlung (Saarbrücken)." },
                { id: "m17", name: "Grube Jägersfreude", coords: [49.2610, 7.0050], type: "Kohle", period: "1856-1968", desc: "Direkt an der Bahnlinie Saarbrücken." },
                { id: "m18", name: "Grube Kohlwald", coords: [49.3680, 7.1980], type: "Kohle", period: "1842-1966", desc: "Grenzgrube bei Wiebelskirchen." },
                { id: "m19", name: "Grube Hirschbach", coords: [49.2850, 7.0450], type: "Kohle", period: "1816-1950", desc: "Dudweiler / Naherholungsgebiet." },
                { id: "m20", name: "Emilianusstollen", coords: [49.3000, 6.7000], type: "Kupfer", period: "Römerzeit", desc: "Antikes Kupferbergwerk (St. Barbara)." },
                { id: "m21", name: "Grube Auersmacher", coords: [49.1500, 7.0500], type: "Kalk", period: "1935-2017", desc: "Kalksteingrube für die Stahlindustrie." },
                { id: "m26", name: "Grube Altenwald", coords: [49.3100, 7.0800], type: "Kohle", period: "1851-1932", desc: "Sulzbach. Förderende 1932, danach Wasserhaltung." },
                { id: "m29", name: "Grube Reisbach / A. Schäfer", coords: [49.3800, 6.9000], type: "Kohle", period: "1962-2000", desc: "Eine der wenigen Privatgruben im Saarland." }
            ],
            steel: [
                { id: "s1", name: "Völklinger Hütte", coords: [49.2485, 6.8442], type: "Stahl", period: "UNESCO", desc: "Weltkulturerbe. Roheisen bis 1986." },
                { id: "s2", name: "Dillinger Hütte", coords: [49.3480, 6.7450], type: "Stahl", period: "Aktiv", desc: "Grobblech-Spezialist, gegr. 1685." },
                { id: "s3", name: "Neunkircher Eisenwerk", coords: [49.3455, 7.1780], type: "Stahl", period: "1593-1982", desc: "Dominierte das Stadtbild ('Stumm-Ära')." },
                { id: "s4", name: "Halberger Hütte", coords: [49.2180, 7.0300], type: "Stahl", period: "Aktiv", desc: "Brebach. Gussrohre und Motorteile." },
                { id: "s5", name: "Burbacher Hütte", coords: [49.2420, 6.9350], type: "Stahl", period: "Aktiv", desc: "Saarbrücken-Burbach. Drahtstraße." },
                { id: "s6", name: "Alte Schmelz", coords: [49.2750, 7.1050], type: "Eisen", period: "1733-1991", desc: "Industriedenkmal St. Ingbert." },
                { id: "s9", name: "Hubertushütte", coords: [49.5800, 6.9500], type: "Eisen", period: "1748-1868", desc: "Bierfeld." }
            ]
        };

        // --- URBAN DATA (INTERPOLATIONS-DATENSATZ MIT EXTRAPOLATION 1926) ---
        const urbanDataRaw = [
            { name: "Saarbrücken", coords: [49.2333, 7.0000], desc: "Landeshauptstadt", history: { 1926:95000, 1950:110000, 1970:125000, 1974:205000, 1990:191000, 2024:181900 }},
            { name: "Neunkirchen", coords: [49.3450, 7.1780], desc: "Hüttenstadt", history: { 1926:38000, 1950:43000, 1965:48000, 1974:55000, 1990:51000, 2024:46900 }},
            { name: "Völklingen", coords: [49.2500, 6.8500], desc: "Stahlstandort", history: { 1926:30000, 1950:39000, 1965:44000, 1974:48000, 1990:44000, 2024:40000 }},
            { name: "Sulzbach", coords: [49.3000, 7.0600], desc: "Bergbauzentrum", history: { 1926:20000, 1950:23000, 1960:25000, 1974:21000, 1990:19000, 2024:16000 }},
            { name: "Friedrichsthal", coords: [49.3250, 7.0950], desc: "Bergbau", history: { 1926:13000, 1950:15000, 1960:16000, 1974:14000, 1990:12000, 2024:10000 }},
            { name: "Saarlouis", coords: [49.3167, 6.7500], desc: "Festungsstadt", history: { 1926:16000, 1950:30000, 1970:36000, 1974:40000, 1990:38000, 2024:34500 }},
            { name: "Homburg", coords: [49.3200, 7.3400], desc: "Heute Uni & Industrie", history: { 1926:12000, 1950:31000, 1970:35000, 1974:44000, 1990:45000, 2024:42000 }},
            { name: "St. Ingbert", coords: [49.2800, 7.1200], desc: "Biosphäre", history: { 1926:20000, 1950:27000, 1970:29000, 1974:40000, 1990:39000, 2024:35500 }},
            { name: "Merzig", coords: [49.4419, 6.6378], desc: "Kreisstadt", history: { 1926:10000, 1950:14000, 1970:16000, 1974:28000, 1990:31000, 2024:30000 }},
            { name: "St. Wendel", coords: [49.4667, 7.1667], desc: "Wirtschaftszentrum Nord", history: { 1926:8000, 1950:11000, 1970:12000, 1974:27000, 1990:27000, 2024:25500 }},
            { name: "Dillingen", coords: [49.3500, 6.7333], desc: "Hüttenstadt", history: { 1926:9000, 1950:18000, 1965:21000, 1974:24000, 1990:22000, 2024:20000 }}
        ];

        const transportData = [
            {name:"RE 1",desc:"Trier - SB - Homburg",color:"#db2777",path:[[49.600,6.550],[49.490,6.590],[49.441,6.637],[49.350,6.733],[49.316,6.750],[49.250,6.850],[49.233,7.000],[49.280,7.120],[49.320,7.340],[49.380,7.350]]},
            {name:"RE 3",desc:"SB - NK - Mainz",color:"#0ea5e9",path:[[49.233,7.000],[49.300,7.060],[49.345,7.178],[49.405,7.165],[49.466,7.166],[49.580,7.150],[49.630,7.180]]},
            {name:"RB 68",desc:"SB - St. Ingbert - Zweibrücken",color:"#2563eb",path:[[49.233,7.000],[49.280,7.120],[49.250,7.250],[49.240,7.350]]},
            {name:"RB 72",desc:"SB - Illingen - Lebach",color:"#8b5cf6",path:[[49.233,7.000],[49.325,7.050],[49.375,7.050],[49.410,6.910]]},
            {name:"RB 77",desc:"Dillingen - Niedaltdorf",color:"#64748b",path:[[49.350,6.733],[49.350,6.600]]},
            {name:"Saarbahn",desc:"Lebach - SB - Saargemünd",color:"#eab308",path:[[49.410,6.910],[49.340,6.930],[49.310,6.940],[49.233,7.000],[49.218,7.030],[49.155,7.035],[49.110,7.080]]}
        ];

        // --- MAP INITIALIZATION ---
        const map = L.map('map', { zoomControl: false }).setView([49.38, 6.95], 10);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 20}).addTo(map);
        let currentLayers = L.layerGroup().addTo(map);

        // --- HELPER FUNCTIONS ---
        function closeWelcome() {
            document.getElementById('welcome-overlay').classList.add('hidden-overlay');
            setTimeout(() => map.flyTo([49.38, 6.98], 10.5, { duration: 2.5 }), 300);
        }

        function clearMap() { 
            currentLayers.clearLayers(); 
            document.getElementById('sidebar-content').innerHTML = ''; 
        }

        function getPopForYear(history, year) {
            const years = Object.keys(history).map(Number).sort((a,b)=>a-b);
            if(year<=years[0]) return history[years[0]]; 
            if(year>=years[years.length-1]) return history[years[years.length-1]];
            let prev=years[0], next=years[years.length-1];
            for(let y of years) { if(y<=year) prev=y; if(y>year) { next=y; break; } }
            const fraction = (year-prev)/(next-prev);
            return Math.round(history[prev] + fraction * (history[next]-history[prev]));
        }

        function updateUrbanMap(val) {
            currentYear = parseInt(val);
            document.getElementById('yearDisplay').innerText = currentYear;
            
            // Gesamtbevölkerung berechnen
            const totalPop = getPopForYear(saarlandPopData, currentYear);
            document.getElementById('total-pop-value').innerText = totalPop.toLocaleString();
            document.getElementById('total-pop-year').innerText = "Jahr: " + currentYear;
            
            // Gebietsreform Hinweis
            const badge = document.getElementById('reform-badge');
            if (currentYear >= 1973 && currentYear <= 1975) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            clearMap(); 
            renderUrban();
        }

        function createExpandableListItem(item, iconClass, colorClass, onClick) {
            const div = document.createElement('div');
            div.className = `group rounded-xl bg-white border border-slate-100 hover:border-slate-300 shadow-sm mb-2 overflow-hidden`;
            const dotColor = colorClass.replace('border-', 'bg-').replace('text-', 'bg-');
            div.innerHTML = `<div class="p-3.5 flex items-center gap-3.5 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('open'); ${onClick?`(${onClick})()`:''}"><div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-xl text-slate-500"><i class="${iconClass}"></i></div><div class="flex-1"><div class="font-bold text-sm text-slate-800">${item.name}</div><div class="text-xs text-slate-500">${item.period || item.desc}</div></div><div class="w-2 h-2 rounded-full ${dotColor}"></div></div><div class="details-content bg-slate-50 text-xs text-slate-600 px-4"><div class="py-3 border-t border-slate-200">${item.desc}</div></div>`;
            return div;
        }

        function createSimpleListItem(title, subtitle, color, onClick) {
            const div = document.createElement('div');
            div.className = "p-3 mb-2 bg-white rounded-lg border-l-4 shadow-sm text-sm cursor-pointer hover:bg-slate-50";
            div.style.borderLeftColor = color;
            div.innerHTML = `<b>${title}</b><br><span class="text-xs text-slate-500">${subtitle}</span>`;
            div.onclick = onClick;
            return div;
        }

        const getMineIcon = (c) => L.divIcon({className: 'custom-div-icon', html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${c}" stroke="white" stroke-width="1.5" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter">G</text></svg>`, iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-32]});
        const getOreIcon = (c) => L.divIcon({className: 'custom-div-icon', html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${c}" stroke="white" stroke-width="1.5" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter">E</text></svg>`, iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-32]});
        const getSteelIcon = (c) => L.divIcon({className: 'custom-div-icon', html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${c}" stroke="white" stroke-width="1.5" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter">H</text></svg>`, iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-32]});

        function renderHistory() {
            document.getElementById('sidebar-title').innerText = "Berg- und Stahlbau";
            document.getElementById('sidebar-desc').innerText = "Kohle, Erz & Stahl";
            const list = document.getElementById('sidebar-content');
            
            if(currentViewMode === 'overview') {
                L.polyline(overviewLines.mining.path, {color: "#ef4444", weight: 20, opacity: 0.4}).addTo(currentLayers).bindTooltip("Kohlegürtel", {sticky: true});
                L.polyline(overviewLines.steel.path, {color: "#475569", weight: 20, opacity: 0.4}).addTo(currentLayers).bindTooltip("Stahlachse", {sticky: true});
                list.innerHTML = `<div class="p-4 bg-slate-50 text-slate-800 text-xs rounded-xl border border-slate-200"><b>Strukturanalyse:</b> Die Linien zeigen die historischen Industrieachsen.</div>`;
            } else {
                historyData.mines.forEach(m => {
                    let icon = m.type === "Kohle" ? getMineIcon('#ef4444') : getOreIcon('#f97316');
                    let color = m.type === "Kohle" ? "bg-red-500" : "bg-orange-500";
                    const marker = L.marker(m.coords, {icon: icon}).addTo(currentLayers);
                    marker.bindPopup(`<b>${m.name}</b><br>${m.period}`);
                    list.appendChild(createExpandableListItem(m, m.type === "Kohle" ? "ph-pick-axe" : "ph-mountains", color, () => { map.flyTo(m.coords, 13); marker.openPopup(); }));
                });
                historyData.steel.forEach(s => {
                    const marker = L.marker(s.coords, {icon: getSteelIcon('#475569')}).addTo(currentLayers);
                    marker.bindPopup(`<b>${s.name}</b><br>${s.period}`);
                    list.appendChild(createExpandableListItem(s, "ph-factory", "bg-slate-600", () => { map.flyTo(s.coords, 13); marker.openPopup(); }));
                });
            }
        }

        function renderUrban() {
            document.getElementById('sidebar-title').innerText = "Bevölkerung";
            document.getElementById('sidebar-desc').innerText = "Zeitvergleich 1926 - 2024";
            const list = document.getElementById('sidebar-content');
            
            if(currentViewMode === 'overview') {
                L.polyline(overviewLines.mining.path, {color: "#ef4444", weight: 20, opacity: 0.2}).addTo(currentLayers);
                L.polyline(overviewLines.steel.path, {color: "#475569", weight: 20, opacity: 0.2}).addTo(currentLayers);
                list.innerHTML = `<div class="p-4 bg-blue-50 text-blue-900 text-xs rounded-xl border border-blue-100"><b>Korrelation:</b> Bevölkerungsschwerpunkte liegen auf den Industrieachsen.</div>`;
            }

            urbanDataRaw.forEach(city => {
                const pop = getPopForYear(city.history, currentYear);
                const radius = Math.sqrt(pop) * 14;
                const color = pop > 100000 ? '#7e22ce' : (pop > 30000 ? '#a855f7' : '#d8b4fe');
                const circle = L.circle(city.coords, {color, fillColor: color, fillOpacity: 0.5, radius, weight: 1}).addTo(currentLayers);
                circle.bindPopup(`<b>${city.name}</b><br>${pop.toLocaleString()} EW`);
                const item = document.createElement('div');
                item.className = "p-3 mb-2 bg-white rounded-lg border-l-4 border-purple-500 shadow-sm text-sm cursor-pointer flex justify-between";
                item.innerHTML = `<span><b>${city.name}</b></span><span>${pop.toLocaleString()}</span>`;
                item.onclick = () => { map.flyTo(city.coords, 13); circle.openPopup(); };
                list.appendChild(item);
            });
        }

        function renderTransport() {
            document.getElementById('sidebar-title').innerText = "Schienennetz";
            document.getElementById('sidebar-desc').innerText = "Aktive Linien";
            const list = document.getElementById('sidebar-content');
            if(currentViewMode === 'overview') {
                 L.polyline(overviewLines.mining.path, {color: "#ef4444", weight: 20, opacity: 0.2}).addTo(currentLayers);
                 L.polyline(overviewLines.steel.path, {color: "#475569", weight: 20, opacity: 0.2}).addTo(currentLayers);
                 list.innerHTML = `<div class="p-4 bg-blue-50 text-blue-900 text-xs rounded-xl border border-blue-100"><b>Historische Pfade:</b> Das moderne Netz folgt den alten Transportwegen.</div>`;
            }
            transportData.forEach(r => {
                const poly = L.polyline(r.path, {color: r.color, weight: 4}).addTo(currentLayers);
                list.appendChild(createSimpleListItem(r.name, r.desc, r.color, () => map.fitBounds(poly.getBounds())));
            });
        }

        function renderLegend(mode) {
            const container = document.getElementById('legend-content');
            const panel = document.getElementById('legend-panel');
            let html = '';

            if (mode === 'transport') {
                panel.classList.add('hidden'); panel.classList.remove('md:block'); return;
            }
            panel.classList.remove('hidden'); panel.classList.add('md:block');

            if (mode === 'history') {
                html = `<div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-red-500 border border-white shadow-sm"></span><span>Steinkohle</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-orange-500 border border-white shadow-sm"></span><span>Erz-/Kalkbergwerk</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-slate-600 border border-white shadow-sm"></span><span>Stahl-/Hüttenwerk</span></div>`;
            } else if (mode === 'urban') {
                html = `<div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-purple-700 opacity-60"></span><span>> 100k EW</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-purple-500 opacity-60"></span><span>> 30k EW</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-purple-300 opacity-60"></span><span>< 30k EW</span></div>`;
            }
            container.innerHTML = html;
        }

        function setViewMode(v) { currentViewMode = v; switchMode(currentMode); }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-600', 'bg-transparent'); });
            document.getElementById(`btn-${mode}`).classList.add('active');
            document.getElementById(`btn-${mode}`).classList.remove('text-slate-600', 'bg-transparent');

            const viewCtrl = document.getElementById('view-controls');
            const timeSlider = document.getElementById('time-slider-container');
            const popDisplay = document.getElementById('total-pop-display');
            
            viewCtrl.classList.remove('hidden'); 
            timeSlider.classList.add('hidden');
            popDisplay.classList.add('hidden');

            if(mode === 'urban') { 
                viewCtrl.classList.add('hidden'); 
                timeSlider.classList.remove('hidden'); 
                popDisplay.classList.remove('hidden');
                currentViewMode = 'details'; 
                // Manuelles Update beim Wechsel
                updateUrbanMap(document.getElementById('yearSlider').value);
            }
            
            renderLegend(mode);
            clearMap();
            if (mode === 'history') renderHistory();
            // Urban wird durch updateUrbanMap oben getriggert
            if (mode === 'transport') renderTransport();
        }

        setTimeout(() => { switchMode('history'); }, 100);
    </script>
</body>
</html>
