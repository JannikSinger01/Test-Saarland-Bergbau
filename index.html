<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Saar: Gestern & Heute</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* BASIS DESIGN */
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            background-color: #f8fafc;
        }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* GLASSMORPHISMUS */
        .glass-panel {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* TAB BUTTONS */
        .tab-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .tab-btn.active {
            background-color: #0f172a; /* Slate 900 */
            color: white;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
        }
        .tab-btn:hover:not(.active) {
            background-color: #f1f5f9;
            transform: translateY(-1px);
        }

        /* RANGE SLIDER CUSTOM STYLING */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #0f172a;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* LEAFLET POPUP ANPASSUNG */
        .leaflet-popup-content-wrapper { 
            border-radius: 12px; 
            padding: 0; 
            overflow: hidden; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            font-family: 'Inter', sans-serif;
        }
        .leaflet-popup-content { margin: 0 !important; width: 260px !important; }
        .leaflet-container a.leaflet-popup-close-button {
            color: #64748b;
            padding: 8px;
            z-index: 10;
        }

        /* DETAILS ANIMATION IN SIDEBAR */
        .details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease;
        }
        .details-content.open {
            max-height: 500px; 
            transition: max-height 0.5s ease-in;
        }

        /* WELCOME OVERLAY */
        #welcome-overlay {
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        #welcome-overlay.hidden-overlay {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .custom-div-icon { background: transparent; border: none; }

        /* ANIMATIONEN */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        .reform-alert {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="relative h-screen w-screen text-slate-800">

    <!-- 1. WELCOME OVERLAY -->
    <div id="welcome-overlay" class="absolute inset-0 z-[9999] bg-slate-900/95 backdrop-blur-md flex items-center justify-center text-white p-6">
        <div class="max-w-3xl text-center space-y-8 fade-in-up">
            <div class="inline-block p-4 bg-white/5 rounded-full mb-2 border border-white/10">
                <i class="ph ph-map-trifold text-5xl text-blue-400"></i>
            </div>
            
            <div class="space-y-4">
                <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight text-white">Atlas Saar</h1>
                <div class="h-1 w-24 bg-blue-500 mx-auto rounded-full opacity-80"></div>
            </div>

            <p class="text-xl md:text-2xl text-slate-300 leading-relaxed font-light max-w-2xl mx-auto">
                Wie hat die Ära der <span class="text-red-400 font-medium">Schwerindustrie</span> das Gesicht des <span class="text-blue-400 font-medium">heutigen Saarlandes</span> geformt?
            </p>
            
            <button onclick="closeWelcome()" class="mt-10 px-10 py-4 bg-white text-slate-900 rounded-full font-bold text-lg shadow-lg hover:bg-blue-50 hover:scale-105 transition-all transform flex items-center gap-2 mx-auto">
                <span>Karte erkunden</span>
                <i class="ph-bold ph-arrow-right"></i>
            </button>
            
            <div class="pt-8 text-xs text-slate-500 font-mono">
                Version 35.0 • Datenstand: 2025
            </div>
        </div>
    </div>

    <!-- 2. NAVIGATION (OBEN MITTE) -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] glass-panel rounded-full p-1.5 flex shadow-xl max-w-[95%] overflow-x-auto border border-white/40">
        <button onclick="switchMode('history')" id="btn-history" class="tab-btn active px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap">
            <i class="ph-fill ph-factory text-lg"></i> Berg- und Stahlbau
        </button>
        <button onclick="switchMode('urban')" id="btn-urban" class="tab-btn px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap">
            <i class="ph-fill ph-buildings text-lg"></i> Urbanisierung
        </button>
        <button onclick="switchMode('transport')" id="btn-transport" class="tab-btn px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap">
            <i class="ph-fill ph-train text-lg"></i> Verkehr
        </button>
    </div>

    <!-- 3. VIEW CONTROL (OBEN LINKS - Nur für History & Transport) -->
    <div id="view-controls" class="absolute top-24 left-4 z-[1000] glass-panel p-2 rounded-lg shadow-lg flex gap-2">
        <button onclick="setViewMode('details')" id="view-details" class="px-3 py-1.5 rounded-md text-xs font-bold bg-slate-800 text-white shadow transition-all flex items-center gap-1">
            <i class="ph-fill ph-map-pin"></i> Details
        </button>
        <button onclick="setViewMode('overview')" id="view-overview" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all flex items-center gap-1">
            <i class="ph-fill ph-wave-sine"></i> Übersicht
        </button>
    </div>

    <!-- 4. GESAMTBEVÖLKERUNG (OBEN LINKS - Nur für Urban) -->
    <div id="total-pop-display" class="absolute top-36 left-4 z-[1000] glass-panel p-4 rounded-xl shadow-lg hidden w-52 border-l-4 border-blue-500 transition-all">
        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Bevölkerung Saarland</div>
        <div class="text-2xl font-extrabold text-slate-800 tabular-nums" id="total-pop-value">---</div>
        <div class="text-[10px] text-slate-500 mt-1 text-right font-mono" id="total-pop-year">Jahr: 2024</div>
    </div>

    <!-- 5. TIME SLIDER (OBEN MITTE - Nur für Urban) -->
    <div id="time-slider-container" class="absolute top-24 left-1/2 transform -translate-x-1/2 z-[1000] glass-panel p-5 rounded-xl shadow-xl w-80 hidden">
        <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">
            <span>1926</span>
            <span>1950</span>
            <span>1974</span>
            <span>2024</span>
        </div>
        <input type="range" id="yearSlider" min="1926" max="2024" step="1" value="2024" oninput="updateUrbanMap(this.value)">
        
        <div class="flex justify-between items-end mt-2">
            <div class="font-bold text-2xl text-slate-800 tabular-nums" id="yearDisplay">2024</div>
            <div id="reform-badge" class="hidden text-[10px] font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded border border-amber-200 reform-alert flex items-center gap-1">
                <i class="ph-bold ph-warning"></i> Gebietsreform
            </div>
        </div>
    </div>

    <!-- 6. LEGENDE (UNTEN LINKS) -->
    <div id="legend-panel" class="absolute bottom-10 left-4 z-[1000] glass-panel p-4 rounded-xl shadow-lg max-w-[200px] transition-all duration-300 hidden md:block">
        <h3 class="font-bold text-[10px] text-slate-400 uppercase mb-2 tracking-widest">Legende</h3>
        <div id="legend-content" class="space-y-2.5 text-xs font-medium text-slate-700">
            <!-- Content wird dynamisch gefüllt -->
        </div>
    </div>

    <!-- 7. SIDEBAR (RECHTS) -->
    <div class="absolute top-24 right-4 bottom-10 w-80 z-[1000] flex flex-col pointer-events-none">
        <div class="glass-panel rounded-2xl shadow-2xl flex flex-col max-h-full pointer-events-auto overflow-hidden transition-all duration-300 hover:shadow-xl">
            <!-- Header -->
            <div class="p-5 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                <h2 id="sidebar-title" class="font-bold text-xl text-slate-800 tracking-tight">Lade Daten...</h2>
                <p id="sidebar-desc" class="text-sm text-slate-500 mt-1 font-medium">Bitte warten</p>
            </div>
            <!-- Liste -->
            <div id="sidebar-content" class="overflow-y-auto p-2 space-y-2 bg-white/60 flex-1">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- MAP CONTAINER -->
    <div id="map"></div>

    <!-- FOOTER -->
    <div class="absolute bottom-0 left-0 z-[1000] bg-white/90 backdrop-blur px-4 py-1.5 text-[11px] font-medium text-slate-500 rounded-tr-xl border-t border-r border-slate-200 shadow-sm">
        © 2025 Atlas Saar | Daten: Stat. Amt Saarland
    </div>

    <!-- LEAFLET JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- CONFIG & STATE ---
        let currentViewMode = 'details'; 
        let currentMode = 'history';
        let currentYear = 2024;

        // --- WELCOME SCREEN LOGIC ---
        function closeWelcome() {
            const overlay = document.getElementById('welcome-overlay');
            overlay.classList.add('hidden-overlay');
            setTimeout(() => {
                map.flyTo([49.38, 6.98], 10.5, { duration: 2.5 });
            }, 300);
        }

        // --- DATEN ---
        
        // OPTIMIERTE GRENZE (~180 Punkte)
        const saarlandBorder = [
            [49.6263, 6.9125], [49.6301, 6.9250], [49.6335, 6.9450], [49.6395, 7.0100], [49.6405, 7.0350], 
            [49.6390, 7.0550], [49.6280, 7.0850], [49.6120, 7.1050], [49.6000, 7.1150], [49.5820, 7.1450], 
            [49.5700, 7.1800], [49.5550, 7.2250], [49.5420, 7.2650], [49.5250, 7.2950], [49.5000, 7.3250], 
            [49.4800, 7.3450], [49.4550, 7.3850], [49.4250, 7.4250], [49.3850, 7.4350], [49.3550, 7.4250], 
            [49.3250, 7.4050], [49.3050, 7.3850], [49.2850, 7.3650], [49.2650, 7.3750], [49.2450, 7.3550], 
            [49.2250, 7.3050], [49.2000, 7.3200], [49.1800, 7.3600], [49.1600, 7.3800], [49.1400, 7.3500], 
            [49.1250, 7.3000], [49.1150, 7.2500], [49.1200, 7.1800], [49.1350, 7.1200], [49.1200, 7.0900], 
            [49.1100, 7.0500], [49.1180, 7.0200], [49.1350, 6.9900], [49.1550, 6.9600], [49.1750, 6.9300], 
            [49.1900, 6.8900], [49.1750, 6.8600], [49.1650, 6.8200], [49.1600, 6.7900], [49.1750, 6.7600], 
            [49.1950, 6.7300], [49.2150, 6.7100], [49.2350, 6.6900], [49.2300, 6.6600], [49.2400, 6.6400], 
            [49.2600, 6.6300], [49.2800, 6.6250], [49.3000, 6.6100], [49.3200, 6.6300], [49.3400, 6.6600], 
            [49.3600, 6.6700], [49.3800, 6.6400], [49.4000, 6.6100], [49.4200, 6.5900], [49.4400, 6.5300], 
            [49.4600, 6.4500], [49.4700, 6.3900], [49.4750, 6.3600], [49.4900, 6.3700], [49.5100, 6.4000], 
            [49.5300, 6.4400], [49.5450, 6.4900], [49.5550, 6.5300], [49.5450, 6.5800], [49.5550, 6.6200], 
            [49.5750, 6.6800], [49.5900, 6.7500], [49.6100, 6.8500], [49.6263, 6.9125]
        ];

        // --- GESAMTBEVÖLKERUNG ---
        const saarlandPopData = {
            1926: 769300, 1927: 772700, 1928: 778100, 1929: 785100, 1930: 794500,
            1931: 802500, 1932: 807700, 1933: 809900, 1934: 818013, 1935: 814576,
            1936: 820666, 1937: 820567, 1938: 823978, 1939: 824000, 1940: 812753,
            1941: 817228, 1942: 751705, 1943: 740000, 1944: 733545, 1945: 745612,
            1946: 857630, 1947: 887709, 1948: 914277, 1949: 935507, 1950: 948716,
            1951: 956549, 1952: 967928, 1953: 977758, 1954: 987650, 1955: 996238,
            1956: 1005173, 1957: 1019144, 1958: 1040146, 1959: 1040108, 1960: 1060493,
            1961: 1083012, 1962: 1096584, 1963: 1106157, 1964: 1117222, 1965: 1127354,
            1966: 1132127, 1967: 1131301, 1968: 1128902, 1969: 1127352, 1970: 1121300,
            1971: 1121990, 1972: 1118569, 1973: 1111878, 1974: 1103255, 1975: 1096333,
            1976: 1088961, 1977: 1081074, 1978: 1072953, 1979: 1068555, 1980: 1066299,
            1981: 1063033, 1982: 1057543, 1983: 1052794, 1984: 1050837, 1985: 1045936,
            1986: 1042135, 1987: 1054064, 1988: 1054142, 1989: 1064906, 1990: 1072963,
            1991: 1076879, 1992: 1084007, 1993: 1084522, 1994: 1084201, 1995: 1084370,
            1996: 1084184, 1997: 1080790, 1998: 1074223, 1999: 1071501, 2000: 1068703,
            2001: 1066470, 2002: 1064988, 2003: 1061376, 2004: 1056417, 2005: 1050293,
            2006: 1043167, 2007: 1036598, 2008: 1030324, 2009: 1022585, 2010: 1017567,
            2011: 997855, 2012: 994287, 2013: 990718, 2014: 989035, 2015: 995597,
            2016: 996651, 2017: 994187, 2018: 990509, 2019: 986887, 2020: 983991,
            2021: 982348, 2022: 992666, 2023: 994424, 2024: 1012141
        };

        const overviewLines = {
            mining: { name: "Kohlegürtel", desc: "Historische Hauptachse des Bergbaus.", color: "#ef4444", path: [[49.180, 6.800], [49.250, 6.850], [49.290, 6.980], [49.310, 7.060], [49.350, 7.120], [49.370, 7.250]] },
            steel: { name: "Stahlachse", desc: "Industrielle Verarbeitung in den Tälern.", color: "#475569", path: [[49.350, 6.740], [49.250, 6.840], [49.240, 6.940], [49.220, 7.030], [49.280, 7.120], [49.345, 7.180], [49.325, 7.335]] }
        };

        const historyData = {
            mines: [
                { 
                    id: "m1", name: "Bergwerk Saar / Ensdorf", coords: [49.3188, 6.7780], type: "Kohle", period: "1833-2012", 
                    desc: "Das letzte aktive Bergwerk des Saarlandes. Am 30.06.2012 endete hier die Ära des Steinkohlebergbaus nach einem Beschluss zum Kohleausstieg. Bekannt ist der Standort heute für das 'Saarpolygon', ein Denkmal auf der Halde Duhamel, das an die Bergbauvergangenheit erinnert." 
                },
                { 
                    id: "m2", name: "Grube Göttelborn", coords: [49.3548, 7.0335], type: "Kohle", period: "1887-2000", 
                    desc: "Einst eine der modernsten Gruben Europas, bekannt als der 'Weiße Riese'. Trotz massiver Investitionen in den 1990er Jahren wurde sie 2000 stillgelegt. Der markante Förderturm von Schacht IV ist das höchste Fördergerüst des Saarlandes und eine weithin sichtbare Landmarke." 
                },
                { 
                    id: "m3", name: "Grube Reden", coords: [49.3493, 7.1132], type: "Kohle", period: "1846-1995", 
                    desc: "Eine der traditionsreichsten Anlagen. Nach der Stilllegung wurde das Gelände in den Freizeitpark 'Gondwana – Das Praehistorium' umgewandelt. Die Grube spielt heute noch eine wichtige Rolle für die zentrale Wasserhaltung im Saarrevier." 
                },
                { 
                    id: "m4", name: "Grube Camphausen", coords: [49.3065, 7.0074], type: "Kohle", period: "1871-1990", 
                    desc: "Architektonisch herausragend durch den Hammerkopfturm in Backstein-Expressionismus. Die Grube war lange Zeit eine der förderstärksten im Fischbachtal. Teile der Anlage stehen unter Denkmalschutz." 
                },
                { 
                    id: "m5", name: "Grube Luisenthal", coords: [49.2477, 6.8938], type: "Kohle", period: "1820-2005", 
                    desc: "Traurige Bekanntheit erlangte die Grube durch das schwerste Grubenunglück in der Geschichte der Bundesrepublik am 7. Februar 1962 mit 299 Toten. Sie war das tiefste Bergwerk an der Saar und wurde 2005 mit Warndt zusammengelegt und geschlossen." 
                },
                { 
                    id: "m6", name: "Grube Warndt", coords: [49.1864, 6.8097], type: "Kohle", period: "1963-2005", 
                    desc: "Das jüngste Großbergwerk des Reviers, geplant in den 1950ern, um die reichen Kohlevorkommen unter dem Warndt zu erschließen. Es zeichnete sich durch modernste Technik aus, bevor es Mitte der 2000er Jahre stillgelegt wurde." 
                },
                { 
                    id: "m7", name: "Grube Velsen", coords: [49.2219, 6.8363], type: "Kohle", period: "1899-2005", 
                    desc: "Bekannt für ihre beeindruckende Kaffeeküche und Architektur. Heute ist Velsen ein beliebtes Erlebnisbergwerk, in dem Besucher die Untertagewelt hautnah erleben können." 
                },
                { 
                    id: "m8", name: "Grube Itzenplitz", coords: [49.3542, 7.0869], type: "Kohle", period: "1856-1960", 
                    desc: "Im Heiligenwald gelegen, besitzt sie das älteste erhaltene Fördergerüst des Saarlandes. Die Anlage liegt malerisch am Itzenplitzer Weiher und ist ein beliebtes Fotomotiv." 
                },
                { 
                    id: "m9", name: "Grube Dechen", coords: [49.3378, 7.1722], type: "Kohle", period: "1854-1968", 
                    desc: "Benannt nach dem preußischen Oberberghauptmann von Dechen. Die Grube war essentiell für die Versorgung der benachbarten Neunkircher Hütte mit Koks." 
                },
                { 
                    id: "m10", name: "Grube Heinitz", coords: [49.3300, 7.1300], type: "Kohle", period: "1847-1964", 
                    desc: "Eine der traditionsreichen Staatsgruben Preußens. Sie trug maßgeblich zum Aufschwung der Stadt Neunkirchen bei. Nach der Stilllegung wurden viele Gebäude abgerissen." 
                },
                { 
                    id: "m11", name: "Grube König", coords: [49.3450, 7.1750], type: "Kohle", period: "1820-1968", 
                    desc: "Zentral in Neunkirchen gelegen. Sie war eng mit dem Eisenwerk verbunden und prägte die industrielle Identität der Stadt über 150 Jahre lang." 
                },
                { 
                    id: "m12", name: "Grube Frankenholz", coords: [49.3702, 7.2405], type: "Kohle", period: "1879-1959", 
                    desc: "Ehemals die tiefste Grube der Pfalz (damals bayrisch). Sie war bekannt für schwierige geologische Verhältnisse und schlagwettergefährdete Flöze." 
                },
                { 
                    id: "m13", name: "Grube St. Ingbert", coords: [49.2830, 7.1180], type: "Kohle", period: "1852-1959", 
                    desc: "Der 'Rischbachstollen' ist heute ein Besucherbergwerk. Die Grube war eine der ältesten der Region und förderte Fettkohle von hoher Qualität." 
                },
                { 
                    id: "m14", name: "Grube Maybach", coords: [49.3205, 7.0632], type: "Kohle", period: "1873-1964", 
                    desc: "Benannt nach Albert von Maybach. Die Grube wurde später mit Reden verbunden. Bekannt ist sie für den Marie-Juchacz-Schacht." 
                },
                { 
                    id: "m15", name: "Grube Viktoria", coords: [49.2927, 6.8882], type: "Kohle", period: "1866-1963", 
                    desc: "Die 'Köllertal-Metropole'. Viktoria war der wichtigste Arbeitgeber in Püttlingen und sorgte für den Ausbau der Infrastruktur im Köllertal." 
                },
                { 
                    id: "m16", name: "Grube Von der Heydt", coords: [49.2688, 6.9575], type: "Kohle", period: "1850-1965", 
                    desc: "Eine idyllische Waldgrube, für die eigens eine Arbeitersiedlung und ein Bahnhof im Wald errichtet wurden. Benannt nach dem Bankier August von der Heydt." 
                },
                { 
                    id: "m17", name: "Grube Jägersfreude", coords: [49.2610, 7.0050], type: "Kohle", period: "1856-1968", 
                    desc: "Direkt an der Hauptbahnlinie bei Saarbrücken gelegen. Sie war bekannt für ihre Koks-Produktion und die gute Verkehrsanbindung." 
                },
                { 
                    id: "m18", name: "Grube Kohlwald", coords: [49.3680, 7.1980], type: "Kohle", period: "1842-1966", 
                    desc: "Grenzgrube bei Wiebelskirchen zur Pfalz. Das Gelände ist heute ein Naturdenkmal, und die Halde bietet einen weiten Ausblick." 
                },
                { 
                    id: "m19", name: "Grube Hirschbach", coords: [49.2850, 7.0450], type: "Kohle", period: "1816-1950", 
                    desc: "Eine der ältesten Gruben in Dudweiler. Das Gelände wurde nach der Stilllegung renaturiert und dient heute als Naherholungsgebiet." 
                },
                { 
                    id: "m20", name: "Emilianusstollen", coords: [49.3000, 6.7000], type: "Kupfer", period: "Römerzeit", 
                    desc: "Einzigartiges Zeugnis römischen Bergbaus nördlich der Alpen. In St. Barbara wurde hier schon in der Antike Kupfererz (Azurit) abgebaut." 
                },
                { 
                    id: "m21", name: "Grube Auersmacher", coords: [49.1500, 7.0500], type: "Kalk", period: "1935-2017", 
                    desc: "Kalksteingrube an der Oberen Saar. Der hier gewonnene Kalk war unverzichtbarer Zuschlagstoff für die Hochöfen der saarländischen Stahlindustrie." 
                },
                { 
                    id: "m22", name: "Grube Korb", coords: [49.5000, 7.1000], type: "Eisen", period: "1912-1989", 
                    desc: "Eisen- und Manganerzgrube bei St. Wendel. Sie war lange Zeit in Betrieb und lieferte Erze für die saarländischen Hütten." 
                },
                { 
                    id: "m23", name: "Grube Walhausen", coords: [49.5500, 7.1000], type: "Kupfer", period: "Mittelalter", 
                    desc: "Historischer Kupferbergbau im nördlichen Saarland. Heute erinnert ein Besucherbergwerk an die lange Tradition des Erzabbaus in der Region." 
                },
                { 
                    id: "m24", name: "Grube Dilsburg", coords: [49.3350, 6.9350], type: "Kohle", period: "1911-1931", 
                    desc: "Heusweiler, als Nebenanlage der Grube Göttelborn betrieben. Sie sollte die Kohlevorräte im Feld Dilsburg erschließen." 
                },
                { 
                    id: "m25", name: "Grube Griesborn", coords: [49.2950, 6.7990], type: "Kohle", period: "1857-1950", 
                    desc: "In Schwalbach gelegen, auch Eisenbahnschacht genannt. Eine wichtige Grube für die Gemeinde Schwalbach." 
                },
                { 
                    id: "m26", name: "Grube Altenwald", coords: [49.3100, 7.0800], type: "Kohle", period: "1851-1932", 
                    desc: "Sulzbach. Hatte eine enge Verbindung zur Sulzbacher Hütte. War über lange Zeit ein bedeutender Arbeitgeber im Sulzbachtal." 
                },
                { 
                    id: "m27", name: "Grube Brefeld", coords: [49.3200, 7.0800], type: "Kohle", period: "1872-1967", 
                    desc: "Gelegen bei Sulzbach/Fischbach. Benannt nach dem preußischen Minister Brefeld." 
                },
                { 
                    id: "m28", name: "Grube Nordfeld", coords: [49.3800, 7.2500], type: "Kohle", period: "1889-1905", 
                    desc: "An der Grenze Waldmohr/Homburg. Ein eher kurzlebiges Bergwerk, das aufgrund schwieriger Verhältnisse geschlossen wurde." 
                },
                { 
                    id: "m29", name: "Grube Reisbach / A. Schäfer", coords: [49.3800, 6.9000], type: "Kohle", period: "1962-2000", 
                    desc: "Eine der wenigen Privatgruben (Dr. Arnold Schäfer) im Saarland (bei Labach/Saarwellingen). Sie existierte noch lange nach der Gründung der Saarbergwerke AG." 
                },
                { 
                    id: "m30", name: "Grube Hostenbach", coords: [49.2600, 6.7800], type: "Kohle", period: "1750-1932", 
                    desc: "Wadgassen. Eine der ältesten Gruben des Landes, eng verbunden mit der Industrialisierung im Bisttal." 
                },
                { 
                    id: "m31", name: "Grube Mellin", coords: [49.3050, 7.0650], type: "Kohle", period: "1856-1932", 
                    desc: "Sulzbach. Bekannt für das neugotische Ensemble der Tagesanlagen, eines der schönsten Industriedenkmäler des Saarlandes." 
                }
            ],
            steel: [
                { 
                    id: "s1", name: "Völklinger Hütte", coords: [49.2485, 6.8442], type: "Stahl", period: "UNESCO", 
                    desc: "Gegründet 1873. Die Roheisenproduktion wurde 1986 eingestellt. 1994 erklärte die UNESCO die Hütte zum Weltkulturerbe, da sie das weltweit einzige vollständig erhaltene Eisenwerk aus der Blütezeit der Industrialisierung ist." 
                },
                { 
                    id: "s2", name: "Dillinger Hütte", coords: [49.3480, 6.7450], type: "Stahl", period: "Aktiv", 
                    desc: "Gegründet 1685, ist sie die älteste Aktiengesellschaft Deutschlands. Sie ist weltweiter Marktführer für hochwertige Grobbleche, die u.a. in Brücken und Windkraftanlagen verbaut werden." 
                },
                { 
                    id: "s3", name: "Neunkircher Eisenwerk", coords: [49.3455, 7.1780], type: "Stahl", period: "1593-1982", 
                    desc: "Unter der Ära der Familie Stumm dominierte das Werk die Stadt Neunkirchen völlig. 1982 wurde der letzte Hochofen ausgeblasen. Teile der Anlage sind als Industriedenkmal erhalten." 
                },
                { 
                    id: "s4", name: "Halberger Hütte", coords: [49.2180, 7.0300], type: "Stahl", period: "Aktiv", 
                    desc: "Traditionsreicher Standort in Brebach-Fechingen, spezialisiert auf Gussrohre und Kurbelgehäuse für die Automobilindustrie (Halberg Guss)." 
                },
                { 
                    id: "s5", name: "Burbacher Hütte", coords: [49.2420, 6.9350], type: "Stahl", period: "Aktiv", 
                    desc: "Gegründet 1856. Heute ein wichtiger Standort von Saarstahl, spezialisiert auf Draht und Stabstahl. Die Hütte prägte den Saarbrücker Stadtteil Burbach maßgeblich." 
                },
                { 
                    id: "s6", name: "Alte Schmelz (St. Ingbert)", coords: [49.2750, 7.1050], type: "Eisen", period: "1733-1991", 
                    desc: "Ein bedeutendes Industriedenkmal. Hier wurde Eisenverarbeitung betrieben, die St. Ingbert zur Industriestadt machte. Die historischen Gebäude werden heute kulturell genutzt." 
                },
                { 
                    id: "s7", name: "Eisenwerk Homburg", coords: [49.3250, 7.3350], type: "Eisen", period: "19. Jh.", 
                    desc: "Wichtiger Standort für die pfälzisch-saarländische Eisenindustrie im 19. Jahrhundert, der die wirtschaftliche Bedeutung Homburgs stärkte." 
                },
                { 
                    id: "s8", name: "Mariahütte", coords: [49.6050, 6.9650], type: "Eisen", period: "ab 17. Jh.", 
                    desc: "Eine der ältesten Hütten im Hochwaldraum (Nonnweiler). Sie nutzte die Wasserkraft der Prims und lokale Erzvorkommen." 
                },
                { 
                    id: "s9", name: "Hubertushütte", coords: [49.5800, 6.9500], type: "Eisen", period: "1748-1868", 
                    desc: "Bierfeld (Nonnweiler). Eine weitere historische Hütte im Hochwald, die lokale Erze verarbeitete." 
                },
                { 
                    id: "s10", name: "Geislauterner Eisenwerk", coords: [49.2350, 6.8300], type: "Eisen", period: "1585-1875", 
                    desc: "Wiege der saarländischen Eisenindustrie in Völklingen. Hier soll der erste Koks-Hochofen des Reviers gestanden haben." 
                },
                { 
                    id: "s11", name: "Eisenwerk Bettingen", coords: [49.4350, 6.8600], type: "Eisen", period: "1686-1868", 
                    desc: "Namensgeber für den Ort 'Schmelz'. Ein bedeutendes Werk der frühen Eisenindustrie im Primsraum." 
                },
                { 
                    id: "s12", name: "Aschbacher Eisenwerk", coords: [49.2300, 6.9100], type: "Eisen", period: "1724-1860", 
                    desc: "Gersweiler. Eine typische Hütte der Barockzeit, die lokale Erze und Holzkohle nutzte." 
                },
                { 
                    id: "s13", name: "Fischbacher Schmelze", coords: [49.3150, 7.0400], type: "Eisen", period: "1728-1860", 
                    desc: "Frühindustrielle Anlage im Fischbachtal, bevor der Kohlebergbau dominierte." 
                },
                { 
                    id: "s14", name: "Goffontaine", coords: [49.2250, 7.0500], type: "Eisen", period: "18. Jh.", 
                    desc: "Schafbrücke. Bekannt für den Drahtzug und die Eisenverarbeitung vor den Toren Saarbrückens." 
                },
                { 
                    id: "s15", name: "Wadgasser Hütte", coords: [49.2700, 6.7900], type: "Eisen/Glas", period: "17.-19. Jh.", 
                    desc: "Ursprünglich Eisenverarbeitung, später weltberühmt für Kristallglas (Villeroy & Boch)." 
                },
                { 
                    id: "s16", name: "Karlsbrunner Hütte", coords: [49.1850, 6.8300], type: "Eisen", period: "18. Jh.", 
                    desc: "Im Warndt gelegen, nah beim Jagdschloss Karlsbrunn. Nutzte die reichen Holzvorkommen des Warndtwaldes." 
                },
                { 
                    id: "s18", name: "Hütte Wecklingen", coords: [49.2300, 7.2500], type: "Eisen", period: "18. Jh.", 
                    desc: "Kleine historische Anlage im Bliestal (Blieskastel)." 
                },
                { 
                    id: "s19", name: "St. Ingberter Eisenwerk", coords: [49.2800, 7.1200], type: "Eisen", period: "19. Jh.", 
                    desc: "Neben der Alten Schmelz ein weiterer wichtiger Standort für Draht- und Nagelproduktion." 
                },
                { 
                    id: "s20", name: "Röhrenwerke Bous", coords: [49.2750, 6.8050], type: "Stahl", period: "Aktiv", 
                    desc: "Mannesmann Röhrenwerke. Spezialisiert auf die Herstellung nahtloser Stahlrohre." 
                },
                { 
                    id: "s21", name: "Hüttigweiler", coords: [49.3880, 7.0800], type: "Eisen", period: "Mittelalter", 
                    desc: "Historischer Standort in Illingen. Der Ortsname verweist auf eine frühe Hütte (Schmelze) oder Siedlung bei einer Hütte." 
                }
            ],
            rails: []
        };

        const urbanDataRaw = [
            { name: "Saarbrücken", coords: [49.2333, 7.0000], desc: "Landeshauptstadt", history: { 1926:95000, 1950:110000, 1970:125000, 1974:205000, 1990:191000, 2024:181900 }},
            { name: "Neunkirchen", coords: [49.3450, 7.1780], desc: "Hüttenstadt", history: { 1926:38000, 1950:43000, 1965:48000, 1974:55000, 1990:51000, 2024:46900 }},
            { name: "Völklingen", coords: [49.2500, 6.8500], desc: "Stahlstandort", history: { 1926:30000, 1950:39000, 1965:44000, 1974:48000, 1990:44000, 2024:40000 }},
            { name: "Sulzbach", coords: [49.3000, 7.0600], desc: "Bergbauzentrum", history: { 1926:20000, 1950:23000, 1960:25000, 1974:21000, 1990:19000, 2024:16000 }},
            { name: "Friedrichsthal", coords: [49.3250, 7.0950], desc: "Bergbau", history: { 1926:13000, 1950:15000, 1960:16000, 1974:14000, 1990:12000, 2024:10000 }},
            { name: "Saarlouis", coords: [49.3167, 6.7500], desc: "Festungsstadt", history: { 1926:16000, 1950:30000, 1970:36000, 1974:40000, 1990:38000, 2024:34500 }},
            { name: "Homburg", coords: [49.3200, 7.3400], desc: "Heute Uni & Industrie", history: { 1926:12000, 1950:31000, 1970:35000, 1974:44000, 1990:45000, 2024:42000 }},
            { name: "St. Ingbert", coords: [49.2800, 7.1200], desc: "Biosphäre", history: { 1926:20000, 1950:27000, 1970:29000, 1974:40000, 1990:39000, 2024:35500 }},
            { name: "Merzig", coords: [49.4419, 6.6378], desc: "Kreisstadt", history: { 1926:10000, 1950:14000, 1970:16000, 1974:28000, 1990:31000, 2024:30000 }},
            { name: "St. Wendel", coords: [49.4667, 7.1667], desc: "Wirtschaftszentrum Nord", history: { 1926:8000, 1950:11000, 1970:12000, 1974:27000, 1990:27000, 2024:25500 }},
            { name: "Dillingen", coords: [49.3500, 6.7333], desc: "Hüttenstadt", history: { 1926:9000, 1950:18000, 1965:21000, 1974:24000, 1990:22000, 2024:20000 }}
        ];

        const transportData = [
            {name:"RE 1",desc:"Trier - SB - Homburg",color:"#db2777",path:[[49.600,6.550],[49.490,6.590],[49.441,6.637],[49.350,6.733],[49.316,6.750],[49.250,6.850],[49.233,7.000],[49.280,7.120],[49.320,7.340],[49.380,7.350]]},
            {name:"RE 3",desc:"SB - NK - Mainz",color:"#0ea5e9",path:[[49.233,7.000],[49.300,7.060],[49.345,7.178],[49.405,7.165],[49.466,7.166],[49.580,7.150],[49.630,7.180]]},
            {name:"RB 68",desc:"SB - St. Ingbert - Zweibrücken",color:"#2563eb",path:[[49.233,7.000],[49.280,7.120],[49.250,7.250],[49.240,7.350]]},
            {name:"RB 72",desc:"SB - Illingen - Lebach",color:"#8b5cf6",path:[[49.233,7.000],[49.325,7.050],[49.375,7.050],[49.410,6.910]]},
            {name:"RB 77",desc:"Dillingen - Niedaltdorf",color:"#64748b",path:[[49.350,6.733],[49.350,6.600]]},
            {name:"Saarbahn",desc:"Lebach - SB - Saargemünd",color:"#eab308",path:[[49.410,6.910],[49.340,6.930],[49.310,6.940],[49.233,7.000],[49.218,7.030],[49.155,7.035],[49.110,7.080]]}
        ];

        // --- MAP SETUP ---
        const map = L.map('map', { zoomControl: false }).setView([49.38, 6.95], 10);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 20}).addTo(map);
        let currentLayers = L.layerGroup().addTo(map);
        let borderLayer = L.layerGroup().addTo(map);
        L.polygon(saarlandBorder, {color: '#64748b', weight: 2, fill: false, dashArray: '6, 6', opacity: 0.75}).addTo(borderLayer);

        // --- HELPER FUNCTIONS ---
        function clearMap() { currentLayers.clearLayers(); document.getElementById('sidebar-content').innerHTML = ''; }

        function getPopForYear(history, year) {
            const years = Object.keys(history).map(Number).sort((a,b)=>a-b);
            if(year<=years[0]) return history[years[0]]; if(year>=years[years.length-1]) return history[years[years.length-1]];
            let prev=years[0], next=years[years.length-1];
            for(let y of years) { if(y<=year) prev=y; if(y>year) { next=y; break; } }
            return Math.round(history[prev] + (year-prev)/(next-prev) * (history[next]-history[prev]));
        }

        function updateUrbanMap(val) {
            currentYear = parseInt(val);
            document.getElementById('yearDisplay').innerText = currentYear;
            const totalPop = getPopForYear(saarlandPopData, currentYear);
            document.getElementById('total-pop-value').innerText = totalPop.toLocaleString();
            document.getElementById('total-pop-year').innerText = "Jahr: " + currentYear;
            
            const badge = document.getElementById('reform-badge');
            if (currentYear >= 1973 && currentYear <= 1975) { badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
            
            clearMap(); renderUrban();
        }

        function expandSidebarItem(id) {
            const contentDiv = document.getElementById(`details-${id}`);
            if (contentDiv) {
                document.querySelectorAll('.details-content').forEach(el => { if(el.id !== `details-${id}`) el.classList.remove('open'); });
                contentDiv.classList.add('open');
                contentDiv.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                contentDiv.parentElement.classList.add('ring-2', 'ring-slate-400');
                setTimeout(() => contentDiv.parentElement.classList.remove('ring-2', 'ring-slate-400'), 1000);
            }
        }

        function createExpandableListItem(item, iconClass, colorClass, onClickMarker) {
            const div = document.createElement('div');
            div.className = `group rounded-xl bg-white border border-slate-100 hover:border-slate-300 shadow-sm mb-2 overflow-hidden`;
            const dotColor = colorClass.replace('border-', 'bg-').replace('text-', 'bg-');
            
            // Badge Logic for List Item Header/Body
            let badgeHtml = '';
            if (item.type) {
                let badgeColor = "bg-slate-100 text-slate-600 border-slate-200";
                if (item.type === "Kohle") badgeColor = "bg-red-50 text-red-600 border-red-100";
                else if (item.type === "Eisen" || item.type === "Kupfer" || item.type === "Kalk") badgeColor = "bg-orange-50 text-orange-600 border-orange-100";
                else if (item.type === "Stahl") badgeColor = "bg-slate-50 text-slate-600 border-slate-200";

                badgeHtml = `<span class="${badgeColor} text-[10px] font-bold px-2 py-0.5 rounded border ml-2">${item.type}</span>`;
            }

            div.innerHTML = `
                <div class="p-3.5 flex items-center gap-3.5 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('open'); ${onClickMarker?`(${onClickMarker})()`:''}">
                    <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-xl text-slate-500">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-sm text-slate-800 flex items-center">
                            ${item.name} 
                            <span class="md:hidden">${badgeHtml}</span>
                        </div>
                        <div class="text-xs text-slate-500 font-medium">${item.period}</div>
                    </div>
                    <div class="w-2 h-2 rounded-full ${dotColor}"></div>
                </div>
                <div id="details-${item.id}" class="details-content bg-slate-50 text-xs text-slate-600 px-4">
                    <div class="py-3 border-t border-slate-200">
                        <div class="mb-2 hidden md:block">${badgeHtml}</div>
                        <p class="leading-relaxed text-justify">${item.desc}</p>
                    </div>
                </div>`;
            return div;
        }

        function createSimpleListItem(title, subtitle, color, onClick) {
            const div = document.createElement('div');
            div.className = "p-3 mb-2 bg-white rounded-lg border-l-4 shadow-sm text-sm cursor-pointer hover:bg-slate-50";
            div.style.borderLeftColor = color;
            div.innerHTML = `<b>${title}</b><br><span class="text-xs text-slate-500">${subtitle}</span>`;
            div.onclick = onClick;
            return div;
        }

        const getMineIcon = (c) => L.divIcon({className: 'custom-div-icon', html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${c}" stroke="white" stroke-width="1.5" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter">G</text></svg>`, iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-32]});
        const getOreIcon = (c) => L.divIcon({className: 'custom-div-icon', html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${c}" stroke="white" stroke-width="1.5" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter">E</text></svg>`, iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-32]});
        const getSteelIcon = (c) => L.divIcon({className: 'custom-div-icon', html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${c}" stroke="white" stroke-width="1.5" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter">H</text></svg>`, iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-32]});

        function addOverviewLines(containerList) {
            const miningLine = L.polyline(overviewLines.mining.path, { color: overviewLines.mining.color, weight: 20, opacity: 0.6, lineCap: 'round', lineJoin: 'round', interactive: false }).addTo(currentLayers);
            const steelLine = L.polyline(overviewLines.steel.path, { color: overviewLines.steel.color, weight: 20, opacity: 0.6, lineCap: 'round', lineJoin: 'round', interactive: false }).addTo(currentLayers);
            if (containerList) { const overlayInfo = document.createElement('div'); overlayInfo.className = "mt-4 p-2 border-t border-slate-200 text-[10px] text-slate-400 text-center uppercase tracking-wider"; overlayInfo.innerHTML = "Industrieachsen eingeblendet"; containerList.appendChild(overlayInfo); }
        }

        function renderLegend(mode) {
            const container = document.getElementById('legend-content');
            const panel = document.getElementById('legend-panel');
            let html = '';
            if (mode === 'transport') { panel.classList.add('hidden'); panel.classList.remove('md:block'); return; }
            panel.classList.remove('hidden'); panel.classList.add('md:block');
            const borderLegend = `<div class="flex items-center gap-2.5 mt-2 pt-2 border-t border-slate-100"><span class="w-6 h-0 border-t-2 border-dashed border-slate-400"></span><span class="text-slate-500">Grobe Landesgrenze</span></div>`;

            if (mode === 'history') {
                html = `<div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-red-500 border border-white shadow-sm"></span><span>Steinkohlebergwerk</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-orange-500 border border-white shadow-sm"></span><span>Erz-/Kalkbergwerk</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-slate-600 border border-white shadow-sm"></span><span>Stahl-/Hüttenwerk</span></div>`;
            } else if (mode === 'urban') {
                html = `<div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-purple-700 opacity-60"></span><span>> 100k EW</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-purple-500 opacity-60"></span><span>> 30k EW</span></div>
                        <div class="flex items-center gap-2.5"><span class="w-3 h-3 rounded-full bg-purple-300 opacity-60"></span><span>< 30k EW</span></div>`;
            }
            container.innerHTML = html + borderLegend;
        }

        function renderHistory() {
            document.getElementById('sidebar-title').innerText = "Berg- und Stahlbau";
            document.getElementById('sidebar-desc').innerText = "Kohle, Erz & Stahl";
            const list = document.getElementById('sidebar-content');
            
            if(currentViewMode === 'overview') {
                L.polyline(overviewLines.mining.path, {color: "#ef4444", weight: 20, opacity: 0.6}).addTo(currentLayers).bindTooltip("Kohlegürtel", {sticky: true});
                L.polyline(overviewLines.steel.path, {color: "#475569", weight: 20, opacity: 0.6}).addTo(currentLayers).bindTooltip("Stahlachse", {sticky: true});
                list.innerHTML = `<div class="p-4 bg-slate-50 text-slate-800 text-xs rounded-xl border border-slate-200"><b>Strukturanalyse:</b> Die Linien zeigen die historischen Industrieachsen.</div>`;
            } else {
                historyData.mines.forEach(m => {
                    let icon = m.type === "Kohle" ? getMineIcon('#ef4444') : getOreIcon('#f97316');
                    let color = m.type === "Kohle" ? "bg-red-500" : "bg-orange-500";
                    const marker = L.marker(m.coords, {icon: icon}).addTo(currentLayers);

                    // ** IMPROVED POPUP **
                    let badgeColor = m.type === "Kohle" ? "bg-red-50 text-red-600 border-red-100" : "bg-orange-50 text-orange-600 border-orange-100";
                    marker.bindPopup(`
                        <div class="w-full bg-white p-3">
                            <div class="flex justify-between items-start">
                                <b class="${m.type==='Kohle'?'text-red-600':'text-orange-600'} block text-sm">${m.name}</b>
                                <span class="${badgeColor} text-[9px] font-bold px-1.5 py-0.5 rounded border">${m.type}</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-1 mb-3">${m.period}</div>
                            <button onclick="expandSidebarItem('${m.id}')" class="w-full text-center bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-bold py-1.5 rounded transition-colors">Weitere Informationen →</button>
                        </div>
                    `);
                    list.appendChild(createExpandableListItem(m, m.type === "Kohle" ? "ph-pick-axe" : "ph-mountains", color, () => { map.flyTo(m.coords, 13); marker.openPopup(); }));
                });
                historyData.steel.forEach(s => {
                    const marker = L.marker(s.coords, {icon: getSteelIcon('#475569')}).addTo(currentLayers);
                    
                    // ** IMPROVED POPUP **
                    let badgeColor = "bg-slate-50 text-slate-600 border-slate-200";
                    marker.bindPopup(`
                        <div class="w-full bg-white p-3">
                            <div class="flex justify-between items-start">
                                <b class="text-slate-700 block text-sm">${s.name}</b>
                                <span class="${badgeColor} text-[9px] font-bold px-1.5 py-0.5 rounded border">${s.type}</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-1 mb-3">${s.period}</div>
                            <button onclick="expandSidebarItem('${s.id}')" class="w-full text-center bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-bold py-1.5 rounded transition-colors">Weitere Informationen →</button>
                        </div>
                    `);
                    list.appendChild(createExpandableListItem(s, "ph-factory", "bg-slate-600", () => { map.flyTo(s.coords, 13); marker.openPopup(); }));
                });
            }
        }

        function renderUrban() {
            document.getElementById('sidebar-title').innerText = "Bevölkerung";
            document.getElementById('sidebar-desc').innerText = "1926 - 2024";
            const list = document.getElementById('sidebar-content');
            document.getElementById('total-pop-display').classList.remove('hidden');
            
            if(currentViewMode === 'overview') {
                L.polyline(overviewLines.mining.path, {color: "#ef4444", weight: 20, opacity: 0.6}).addTo(currentLayers);
                L.polyline(overviewLines.steel.path, {color: "#475569", weight: 20, opacity: 0.6}).addTo(currentLayers);
                list.innerHTML = `<div class="p-4 bg-blue-50 text-blue-900 text-xs rounded-xl border border-blue-100"><b>Korrelation:</b> Bevölkerungsschwerpunkte liegen auf den Industrieachsen.</div>`;
            }

            urbanDataRaw.forEach(city => {
                const pop = getPopForYear(city.history, currentYear);
                const radius = Math.sqrt(pop) * 20; 
                const color = pop > 100000 ? '#7e22ce' : (pop > 30000 ? '#a855f7' : '#d8b4fe');
                const circle = L.circle(city.coords, {color, fillColor: color, fillOpacity: 0.5, radius, weight: 1}).addTo(currentLayers);
                circle.bindPopup(`<b>${city.name}</b><br>${pop.toLocaleString()} EW`);
                const item = document.createElement('div');
                item.className = "p-3 mb-2 bg-white rounded-lg border-l-4 border-purple-500 shadow-sm text-sm cursor-pointer flex justify-between";
                item.innerHTML = `<span><b>${city.name}</b></span><span>${pop.toLocaleString()}</span>`;
                item.onclick = () => { map.flyTo(city.coords, 13); circle.openPopup(); };
                list.appendChild(item);
            });
        }

        function renderTransport() {
            document.getElementById('sidebar-title').innerText = "Schienennetz";
            document.getElementById('sidebar-desc').innerText = "Aktive Linien";
            const list = document.getElementById('sidebar-content');
            if(currentViewMode === 'overview') {
                 L.polyline(overviewLines.mining.path, {color: "#ef4444", weight: 20, opacity: 0.6}).addTo(currentLayers);
                 L.polyline(overviewLines.steel.path, {color: "#475569", weight: 20, opacity: 0.6}).addTo(currentLayers);
                 list.innerHTML = `<div class="p-4 bg-blue-50 text-blue-900 text-xs rounded-xl border border-blue-100"><b>Historische Pfade:</b> Das moderne Netz folgt den alten Transportwegen.</div>`;
            }
            transportData.forEach(r => {
                const poly = L.polyline(r.path, {color: r.color, weight: 4}).addTo(currentLayers);
                list.appendChild(createSimpleListItem(r.name, r.desc, r.color, () => map.fitBounds(poly.getBounds())));
            });
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-600', 'bg-transparent'); });
            document.getElementById(`btn-${mode}`).classList.add('active');
            document.getElementById(`btn-${mode}`).classList.remove('text-slate-600', 'bg-transparent');

            const viewCtrl = document.getElementById('view-controls');
            const timeSlider = document.getElementById('time-slider-container');
            const popDisplay = document.getElementById('total-pop-display');
            
            viewCtrl.classList.remove('hidden'); 
            timeSlider.classList.add('hidden');
            popDisplay.classList.add('hidden');

            if(mode === 'urban') { 
                viewCtrl.classList.add('hidden'); 
                timeSlider.classList.remove('hidden'); 
                popDisplay.classList.remove('hidden');
                currentViewMode = 'details'; 
                updateUrbanMap(document.getElementById('yearSlider').value);
            }
            
            renderLegend(mode);
            clearMap();
            if (mode === 'history') renderHistory();
            if (mode === 'transport') renderTransport();
        }

        setTimeout(() => { switchMode('history'); }, 100);
    </script>
</body>
</html>
