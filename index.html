<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Saar: Gestern & Heute</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons (Sidebar) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* BASIS DESIGN */
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            background-color: #f8fafc;
        }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* GLASSMORPHISMUS */
        .glass-panel {
            background: rgba(255, 255, 255, 0.90);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* TAB BUTTONS */
        .tab-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .tab-btn.active {
            background-color: #0f172a; /* Slate 900 */
            color: white;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
        }
        .tab-btn:hover:not(.active) {
            background-color: #f1f5f9;
            transform: translateY(-1px);
        }

        /* LEAFLET POPUP ANPASSUNG */
        .leaflet-popup-content-wrapper { 
            border-radius: 12px; 
            padding: 0; 
            overflow: hidden; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            font-family: 'Inter', sans-serif;
        }
        .leaflet-popup-content { margin: 0 !important; width: 260px !important; }
        .leaflet-container a.leaflet-popup-close-button {
            color: #64748b;
            padding: 8px;
            z-index: 10;
        }

        /* DETAILS ANIMATION IN SIDEBAR */
        .details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease;
        }
        .details-content.open {
            max-height: 500px; 
            transition: max-height 0.5s ease-in;
        }

        /* WELCOME OVERLAY */
        #welcome-overlay {
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        #welcome-overlay.hidden-overlay {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .custom-div-icon { background: transparent; border: none; }
    </style>
</head>
<body class="relative h-screen w-screen text-slate-800">

    <!-- WELCOME OVERLAY (Text angepasst) -->
    <div id="welcome-overlay" class="absolute inset-0 z-[9999] bg-slate-900/95 backdrop-blur-md flex items-center justify-center text-white p-6">
        <div class="max-w-3xl text-center space-y-8 animate-fade-in-up">
            <div class="inline-block p-4 bg-white/5 rounded-full mb-2 border border-white/10">
                <i class="ph ph-map-trifold text-5xl text-blue-400"></i>
            </div>
            
            <div class="space-y-4">
                <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight text-white">Atlas Saar</h1>
                <div class="h-1 w-24 bg-blue-500 mx-auto rounded-full opacity-80"></div>
            </div>

            <!-- NEUE FRAGE -->
            <p class="text-xl md:text-2xl text-slate-300 leading-relaxed font-light max-w-2xl mx-auto">
                Wie hat die Ära der <span class="text-red-400 font-medium">Schwerindustrie</span> das Gesicht des <span class="text-blue-400 font-medium">heutigen Saarlandes</span> geformt?
            </p>
            
            <button onclick="closeWelcome()" class="mt-10 px-10 py-4 bg-white text-slate-900 rounded-full font-bold text-lg shadow-[0_0_30px_rgba(255,255,255,0.2)] hover:bg-blue-50 hover:scale-105 transition-all transform flex items-center gap-2 mx-auto">
                <span>Karte erkunden</span>
                <i class="ph-bold ph-arrow-right"></i>
            </button>
            
            <div class="pt-8 text-xs text-slate-500 font-mono">
                Version 1.0 • Datenstand: 2025
            </div>
        </div>
    </div>

    <!-- TOP NAVIGATION -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] glass-panel rounded-full p-1.5 flex shadow-xl max-w-[95%] overflow-x-auto border border-white/40">
        <button onclick="switchMode('history')" id="btn-history" class="tab-btn active px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap">
            <i class="ph-fill ph-factory text-lg"></i> Berg- und Stahlbau
        </button>
        <button onclick="switchMode('urban')" id="btn-urban" class="tab-btn px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap">
            <i class="ph-fill ph-buildings text-lg"></i> Urbanisierung
        </button>
        <button onclick="switchMode('transport')" id="btn-transport" class="tab-btn px-5 py-2.5 rounded-full text-sm font-semibold flex items-center gap-2 whitespace-nowrap">
            <i class="ph-fill ph-train text-lg"></i> Verkehr
        </button>
    </div>

    <!-- VIEW CONTROL (GLOBAL) -->
    <div id="view-controls" class="absolute top-24 left-4 z-[1000]">
        <div class="glass-panel p-2 rounded-lg shadow-lg flex gap-2">
            <button onclick="setViewMode('details')" id="view-details" class="px-3 py-1.5 rounded-md text-xs font-bold bg-slate-800 text-white shadow transition-all flex items-center gap-1">
                <i class="ph-fill ph-map-pin"></i> Details
            </button>
            <button onclick="setViewMode('overview')" id="view-overview" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all flex items-center gap-1">
                <i class="ph-fill ph-wave-sine"></i> Übersicht
            </button>
        </div>
    </div>

    <!-- LEGEND -->
    <div id="legend-panel" class="absolute bottom-10 left-4 z-[1000] glass-panel p-4 rounded-xl shadow-lg max-w-[200px] transition-all duration-300 hidden md:block">
        <h3 class="font-bold text-[10px] text-slate-400 uppercase mb-2 tracking-widest">Legende</h3>
        <div id="legend-content" class="space-y-2.5 text-xs font-medium text-slate-700">
            <!-- Content wird dynamisch gefüllt -->
        </div>
    </div>

    <!-- SIDEBAR INFO -->
    <div class="absolute top-24 right-4 bottom-10 w-80 z-[1000] flex flex-col pointer-events-none">
        <div class="glass-panel rounded-2xl shadow-2xl flex flex-col max-h-full pointer-events-auto overflow-hidden transition-all duration-300 hover:shadow-xl">
            <!-- Header -->
            <div class="p-5 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                <h2 id="sidebar-title" class="font-bold text-xl text-slate-800 tracking-tight">Lade Daten...</h2>
                <p id="sidebar-desc" class="text-sm text-slate-500 mt-1 font-medium">Bitte warten</p>
            </div>
            <!-- Liste -->
            <div id="sidebar-content" class="overflow-y-auto p-2 space-y-2 bg-white/60 flex-1">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- FOOTER -->
    <div class="absolute bottom-0 left-0 z-[1000] bg-white/90 backdrop-blur px-4 py-1.5 text-[11px] font-medium text-slate-500 rounded-tr-xl border-t border-r border-slate-200 shadow-sm">
        © 2025 Atlas Saar | Design: Vibe-Coding
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- CONFIG & STATE ---
        let currentViewMode = 'details'; 
        let currentMode = 'history';

        // --- WELCOME SCREEN LOGIC ---
        function closeWelcome() {
            const overlay = document.getElementById('welcome-overlay');
            overlay.classList.add('hidden-overlay');
            setTimeout(() => {
                map.flyTo([49.38, 6.98], 10.5, { duration: 2.5 });
            }, 300);
        }

        // --- DATEN ---
        
        // HIGH-RES LANDESGRENZE
        const saarlandBorder = [
            [49.6263, 6.9125], [49.6275, 6.9150], [49.6290, 6.9200], [49.6301, 6.9250], [49.6315, 6.9350],
            [49.6335, 6.9450], [49.6345, 6.9550], [49.6350, 6.9650], [49.6360, 6.9750], [49.6370, 6.9850],
            [49.6385, 6.9950], [49.6395, 7.0100], [49.6400, 7.0250], [49.6405, 7.0350], [49.6400, 7.0450],
            [49.6390, 7.0550], [49.6375, 7.0650], [49.6350, 7.0700], [49.6320, 7.0750], [49.6280, 7.0850],
            [49.6240, 7.0900], [49.6200, 7.0950], [49.6160, 7.1000], [49.6120, 7.1050], [49.6085, 7.1100],
            [49.6050, 7.1150], [49.6015, 7.1200], [49.5980, 7.1250], [49.5940, 7.1300], [49.5900, 7.1350],
            [49.5860, 7.1400], [49.5820, 7.1450], [49.5785, 7.1525], [49.5750, 7.1600], [49.5725, 7.1700],
            [49.5700, 7.1800], [49.5675, 7.1900], [49.5650, 7.2000], [49.5625, 7.2075], [49.5600, 7.2150],
            [49.5575, 7.2225], [49.5550, 7.2300], [49.5525, 7.2375], [49.5500, 7.2450], [49.5475, 7.2525],
            [49.5450, 7.2600], [49.5425, 7.2675], [49.5400, 7.2750], [49.5375, 7.2800], [49.5350, 7.2850],
            [49.5300, 7.2900], [49.5250, 7.2950], [49.5200, 7.3000], [49.5150, 7.3050], [49.5100, 7.3100],
            [49.5050, 7.3150], [49.5000, 7.3200], [49.4950, 7.3250], [49.4900, 7.3300], [49.4850, 7.3350],
            [49.4800, 7.3400], [49.4750, 7.3450], [49.4700, 7.3500], [49.4650, 7.3550], [49.4600, 7.3600],
            [49.4550, 7.3650], [49.4500, 7.3700], [49.4450, 7.3750], [49.4400, 7.3800], [49.4350, 7.3850],
            [49.4300, 7.3900], [49.4250, 7.3950], [49.4200, 7.4000], [49.4150, 7.4050], [49.4100, 7.4100],
            [49.4050, 7.4150], [49.4000, 7.4200], [49.3950, 7.4250], [49.3900, 7.4275], [49.3850, 7.4300],
            [49.3800, 7.4275], [49.3750, 7.4250], [49.3700, 7.4225], [49.3650, 7.4200], [49.3600, 7.4175],
            [49.3550, 7.4150], [49.3500, 7.4125], [49.3450, 7.4100], [49.3400, 7.4075], [49.3350, 7.4050],
            [49.3300, 7.4025], [49.3250, 7.4000], [49.3200, 7.3975], [49.3150, 7.3950], [49.3100, 7.3925],
            [49.3050, 7.3900], [49.3000, 7.3875], [49.2950, 7.3850], [49.2900, 7.3825], [49.2850, 7.3800],
            [49.2800, 7.3775], [49.2750, 7.3750], [49.2700, 7.3725], [49.2650, 7.3700], [49.2600, 7.3675],
            [49.2550, 7.3650], [49.2500, 7.3625], [49.2450, 7.3600], [49.2400, 7.3550], [49.2350, 7.3500],
            [49.2300, 7.3400], [49.2250, 7.3300], [49.2225, 7.3200], [49.2200, 7.3100], [49.2175, 7.3000],
            [49.2150, 7.2900], [49.2125, 7.3000], [49.2100, 7.3100], [49.2050, 7.3200], [49.2000, 7.3300],
            [49.1950, 7.3400], [49.1900, 7.3500], [49.1850, 7.3600], [49.1800, 7.3700], [49.1750, 7.3800],
            [49.1700, 7.3900], [49.1650, 7.3850], [49.1600, 7.3800], [49.1550, 7.3700], [49.1500, 7.3600],
            [49.1475, 7.3500], [49.1450, 7.3400], [49.1425, 7.3300], [49.1400, 7.3200], [49.1375, 7.3100],
            [49.1350, 7.3000], [49.1325, 7.2900], [49.1300, 7.2800], [49.1275, 7.2700], [49.1250, 7.2600],
            [49.1225, 7.2500], [49.1200, 7.2400], [49.1175, 7.2300], [49.1150, 7.2200], [49.1150, 7.2100],
            [49.1150, 7.2000], [49.1175, 7.1900], [49.1200, 7.1800], [49.1225, 7.1700], [49.1250, 7.1600],
            [49.1275, 7.1500], [49.1300, 7.1400], [49.1325, 7.1300], [49.1350, 7.1200], [49.1325, 7.1100],
            [49.1300, 7.1000], [49.1275, 7.0900], [49.1250, 7.0800], [49.1225, 7.0700], [49.1200, 7.0600],
            [49.1175, 7.0500], [49.1150, 7.0400], [49.1150, 7.0300], [49.1150, 7.0200], [49.1175, 7.0100],
            [49.1200, 7.0000], [49.1250, 6.9900], [49.1300, 6.9800], [49.1350, 6.9700], [49.1400, 6.9600],
            [49.1450, 6.9500], [49.1500, 6.9400], [49.1550, 6.9300], [49.1600, 6.9200], [49.1650, 6.9100],
            [49.1700, 6.9000], [49.1750, 6.8900], [49.1800, 6.8800], [49.1825, 6.8700], [49.1850, 6.8600],
            [49.1825, 6.8500], [49.1800, 6.8400], [49.1750, 6.8300], [49.1700, 6.8200], [49.1675, 6.8100],
            [49.1650, 6.8000], [49.1650, 6.7900], [49.1650, 6.7800], [49.1675, 6.7700], [49.1700, 6.7600],
            [49.1750, 6.7500], [49.1800, 6.7400], [49.1850, 6.7300], [49.1900, 6.7200], [49.1950, 6.7100],
            [49.2000, 6.7000], [49.2050, 6.6900], [49.2100, 6.6800], [49.2150, 6.6700], [49.2200, 6.6600],
            [49.2250, 6.6550], [49.2300, 6.6500], [49.2350, 6.6450], [49.2400, 6.6400], [49.2450, 6.6350],
            [49.2500, 6.6300], [49.2550, 6.6275], [49.2600, 6.6250], [49.2650, 6.6225], [49.2700, 6.6200],
            [49.2750, 6.6200], [49.2800, 6.6200], [49.2850, 6.6200], [49.2900, 6.6200], [49.2950, 6.6225],
            [49.3000, 6.6250], [49.3050, 6.6275], [49.3100, 6.6300], [49.3150, 6.6350], [49.3200, 6.6400],
            [49.3250, 6.6450], [49.3300, 6.6500], [49.3350, 6.6550], [49.3400, 6.6600], [49.3450, 6.6625],
            [49.3500, 6.6650], [49.3550, 6.6625], [49.3600, 6.6600], [49.3650, 6.6550], [49.3700, 6.6500],
            [49.3750, 6.6450], [49.3800, 6.6400], [49.3850, 6.6350], [49.3900, 6.6300], [49.3950, 6.6250],
            [49.4000, 6.6200], [49.4050, 6.6150], [49.4100, 6.6100], [49.4150, 6.6050], [49.4200, 6.6000],
            [49.4250, 6.5900], [49.4300, 6.5800], [49.4350, 6.5700], [49.4400, 6.5600], [49.4450, 6.5500],
            [49.4500, 6.5400], [49.4525, 6.5300], [49.4550, 6.5200], [49.4575, 6.5100], [49.4600, 6.5000],
            [49.4625, 6.4900], [49.4650, 6.4800], [49.4675, 6.4700], [49.4700, 6.4600], [49.4725, 6.4500],
            [49.4750, 6.4400], [49.4765, 6.4300], [49.4780, 6.4200], [49.4790, 6.4100], [49.4800, 6.4000],
            [49.4775, 6.3900], [49.4750, 6.3800], [49.4735, 6.3725], [49.4720, 6.3650], [49.4735, 6.3625],
            [49.4750, 6.3600], [49.4800, 6.3650], [49.4850, 6.3700], [49.4900, 6.3750], [49.4950, 6.3800],
            [49.5000, 6.3850], [49.5050, 6.3900], [49.5100, 6.3950], [49.5150, 6.4000], [49.5200, 6.4100],
            [49.5250, 6.4200], [49.5300, 6.4300], [49.5350, 6.4400], [49.5400, 6.4500], [49.5450, 6.4600],
            [49.5500, 6.4700], [49.5550, 6.4800], [49.5550, 6.4900], [49.5550, 6.5000], [49.5525, 6.5100],
            [49.5500, 6.5200], [49.5475, 6.5300], [49.5450, 6.5400], [49.5450, 6.5500], [49.5450, 6.5600],
            [49.5475, 6.5700], [49.5500, 6.5800], [49.5525, 6.5900], [49.5550, 6.6000], [49.5575, 6.6100],
            [49.5600, 6.6200], [49.5625, 6.6300], [49.5650, 6.6400], [49.5675, 6.6500], [49.5700, 6.6600],
            [49.5725, 6.6700], [49.5750, 6.6800], [49.5775, 6.6900], [49.5800, 6.7000], [49.5825, 6.7100],
            [49.5850, 6.7200], [49.5875, 6.7300], [49.5900, 6.7400], [49.5925, 6.7500], [49.5950, 6.7600],
            [49.5975, 6.7700], [49.6000, 6.7800], [49.6025, 6.7900], [49.6050, 6.8000], [49.6075, 6.8100],
            [49.6100, 6.8200], [49.6125, 6.8300], [49.6150, 6.8400], [49.6175, 6.8500], [49.6200, 6.8600],
            [49.6225, 6.8700], [49.6250, 6.8800], [49.6260, 6.8950], [49.6263, 6.9125]
        ];

        const overviewLines = {
            mining: {
                name: "Kohlegürtel",
                desc: "Historische Hauptachse des Bergbaus.",
                color: "#ef4444", // Rot
                path: [[49.180, 6.800], [49.250, 6.850], [49.290, 6.980], [49.310, 7.060], [49.350, 7.120], [49.370, 7.250]]
            },
            steel: {
                name: "Stahlachse",
                desc: "Industrielle Verarbeitung in den Tälern.",
                color: "#475569", // Slate
                path: [[49.350, 6.740], [49.250, 6.840], [49.240, 6.940], [49.220, 7.030], [49.280, 7.120], [49.345, 7.180], [49.325, 7.335]]
            }
        };

        const historyData = {
            mines: [
                // -- GROSSBERGWERKE STEINKOHLE --
                { 
                    id: "m1", name: "Bergwerk Saar / Ensdorf", coords: [49.3188, 6.7780], type: "Kohle", period: "1833-2012", 
                    desc: "Das letzte aktive Bergwerk des Saarlandes. Am 30.06.2012 endete hier die Ära des Steinkohlebergbaus nach einem Beschluss zum Kohleausstieg. Bekannt ist der Standort heute für das 'Saarpolygon', ein Denkmal auf der Halde Duhamel, das an die Bergbauvergangenheit erinnert." 
                },
                { 
                    id: "m2", name: "Grube Göttelborn", coords: [49.3548, 7.0335], type: "Kohle", period: "1887-2000", 
                    desc: "Einst eine der modernsten Gruben Europas, bekannt als der 'Weiße Riese'. Trotz massiver Investitionen in den 1990er Jahren wurde sie 2000 stillgelegt. Der markante Förderturm von Schacht IV ist das höchste Fördergerüst des Saarlandes und eine weithin sichtbare Landmarke." 
                },
                { 
                    id: "m3", name: "Grube Reden", coords: [49.3493, 7.1132], type: "Kohle", period: "1846-1995", 
                    desc: "Eine der traditionsreichsten Anlagen. Nach der Stilllegung wurde das Gelände in den Freizeitpark 'Gondwana – Das Praehistorium' umgewandelt. Die Grube spielt heute noch eine wichtige Rolle für die zentrale Wasserhaltung im Saarrevier." 
                },
                { 
                    id: "m4", name: "Grube Camphausen", coords: [49.3065, 7.0074], type: "Kohle", period: "1871-1990", 
                    desc: "Architektonisch herausragend durch den Hammerkopfturm in Backstein-Expressionismus. Die Grube war lange Zeit eine der förderstärksten im Fischbachtal. Teile der Anlage stehen unter Denkmalschutz." 
                },
                { 
                    id: "m5", name: "Grube Luisenthal", coords: [49.2477, 6.8938], type: "Kohle", period: "1820-2005", 
                    desc: "Traurige Bekanntheit erlangte die Grube durch das schwerste Grubenunglück in der Geschichte der Bundesrepublik am 7. Februar 1962 mit 299 Toten. Sie war das tiefste Bergwerk an der Saar und wurde 2005 mit Warndt zusammengelegt und geschlossen." 
                },
                { 
                    id: "m6", name: "Grube Warndt", coords: [49.1864, 6.8097], type: "Kohle", period: "1963-2005", 
                    desc: "Das jüngste Großbergwerk des Reviers, geplant in den 1950ern, um die reichen Kohlevorkommen unter dem Warndt zu erschließen. Es zeichnete sich durch modernste Technik aus, bevor es Mitte der 2000er Jahre stillgelegt wurde." 
                },
                { 
                    id: "m7", name: "Grube Velsen", coords: [49.2219, 6.8363], type: "Kohle", period: "1899-2005", 
                    desc: "Bekannt für ihre beeindruckende Kaffeeküche und Architektur. Heute ist Velsen ein beliebtes Erlebnisbergwerk, in dem Besucher die Untertagewelt hautnah erleben können." 
                },
                { 
                    id: "m8", name: "Grube Itzenplitz", coords: [49.3542, 7.0869], type: "Kohle", period: "1856-1960", 
                    desc: "Im Heiligenwald gelegen, besitzt sie das älteste erhaltene Fördergerüst des Saarlandes. Die Anlage liegt malerisch am Itzenplitzer Weiher und ist ein beliebtes Fotomotiv." 
                },
                { 
                    id: "m9", name: "Grube Dechen", coords: [49.3378, 7.1722], type: "Kohle", period: "1854-1968", 
                    desc: "Benannt nach dem preußischen Oberberghauptmann von Dechen. Die Grube war essentiell für die Versorgung der benachbarten Neunkircher Hütte mit Koks." 
                },
                { 
                    id: "m10", name: "Grube Heinitz", coords: [49.3300, 7.1300], type: "Kohle", period: "1847-1964", 
                    desc: "Eine der traditionsreichen Staatsgruben Preußens. Sie trug maßgeblich zum Aufschwung der Stadt Neunkirchen bei. Nach der Stilllegung wurden viele Gebäude abgerissen." 
                },
                { 
                    id: "m11", name: "Grube König", coords: [49.3450, 7.1750], type: "Kohle", period: "1820-1968", 
                    desc: "Zentral in Neunkirchen gelegen. Sie war eng mit dem Eisenwerk verbunden und prägte die industrielle Identität der Stadt über 150 Jahre lang." 
                },
                { 
                    id: "m12", name: "Grube Frankenholz", coords: [49.3702, 7.2405], type: "Kohle", period: "1879-1959", 
                    desc: "Ehemals die tiefste Grube der Pfalz (damals bayrisch). Sie war bekannt für schwierige geologische Verhältnisse und schlagwettergefährdete Flöze." 
                },
                { 
                    id: "m13", name: "Grube St. Ingbert", coords: [49.2830, 7.1180], type: "Kohle", period: "1852-1959", 
                    desc: "Der 'Rischbachstollen' ist heute ein Besucherbergwerk. Die Grube war eine der ältesten der Region und förderte Fettkohle von hoher Qualität." 
                },
                { 
                    id: "m14", name: "Grube Maybach", coords: [49.3205, 7.0632], type: "Kohle", period: "1873-1964", 
                    desc: "Benannt nach Albert von Maybach. Die Grube wurde später mit Reden verbunden. Bekannt ist sie für den Marie-Juchacz-Schacht." 
                },
                { 
                    id: "m15", name: "Grube Viktoria", coords: [49.2927, 6.8882], type: "Kohle", period: "1866-1963", 
                    desc: "Die 'Köllertal-Metropole'. Viktoria war der wichtigste Arbeitgeber in Püttlingen und sorgte für den Ausbau der Infrastruktur im Köllertal." 
                },
                { 
                    id: "m16", name: "Grube Von der Heydt", coords: [49.2688, 6.9575], type: "Kohle", period: "1850-1965", 
                    desc: "Eine idyllische Waldgrube, für die eigens eine Arbeitersiedlung und ein Bahnhof im Wald errichtet wurden. Benannt nach dem Bankier August von der Heydt." 
                },
                { 
                    id: "m17", name: "Grube Jägersfreude", coords: [49.2610, 7.0050], type: "Kohle", period: "1856-1968", 
                    desc: "Direkt an der Hauptbahnlinie bei Saarbrücken gelegen. Sie war bekannt für ihre Koks-Produktion und die gute Verkehrsanbindung." 
                },
                { 
                    id: "m18", name: "Grube Kohlwald", coords: [49.3680, 7.1980], type: "Kohle", period: "1842-1966", 
                    desc: "Grenzgrube bei Wiebelskirchen zur Pfalz. Das Gelände ist heute ein Naturdenkmal, und die Halde bietet einen weiten Ausblick." 
                },
                { 
                    id: "m19", name: "Grube Hirschbach", coords: [49.2850, 7.0450], type: "Kohle", period: "1816-1950", 
                    desc: "Eine der ältesten Gruben in Dudweiler. Das Gelände wurde nach der Stilllegung renaturiert und dient heute als Naherholungsgebiet." 
                },
                { 
                    id: "m20", name: "Emilianusstollen", coords: [49.3000, 6.7000], type: "Kupfer", period: "Römerzeit", 
                    desc: "Einzigartiges Zeugnis römischen Bergbaus nördlich der Alpen. In St. Barbara wurde hier schon in der Antike Kupfererz (Azurit) abgebaut." 
                },
                { 
                    id: "m21", name: "Grube Auersmacher", coords: [49.1500, 7.0500], type: "Kalk", period: "1935-2017", 
                    desc: "Kalksteingrube an der Oberen Saar. Der hier gewonnene Kalk war unverzichtbarer Zuschlagstoff für die Hochöfen der saarländischen Stahlindustrie." 
                },
                { 
                    id: "m22", name: "Grube Korb", coords: [49.5000, 7.1000], type: "Eisen", period: "1912-1989", 
                    desc: "Eisen- und Manganerzgrube bei St. Wendel. Sie war lange Zeit in Betrieb und lieferte Erze für die saarländischen Hütten." 
                },
                { 
                    id: "m23", name: "Grube Walhausen", coords: [49.5500, 7.1000], type: "Kupfer", period: "Mittelalter", 
                    desc: "Historischer Kupferbergbau im nördlichen Saarland. Heute erinnert ein Besucherbergwerk an die lange Tradition des Erzabbaus in der Region." 
                },
                { 
                    id: "m24", name: "Grube Dilsburg", coords: [49.3350, 6.9350], type: "Kohle", period: "1911-1931", 
                    desc: "Heusweiler, als Nebenanlage der Grube Göttelborn betrieben. Sie sollte die Kohlevorräte im Feld Dilsburg erschließen." 
                },
                { 
                    id: "m25", name: "Grube Griesborn", coords: [49.2950, 6.7990], type: "Kohle", period: "1857-1950", 
                    desc: "In Schwalbach gelegen, auch Eisenbahnschacht genannt. Eine wichtige Grube für die Gemeinde Schwalbach." 
                },
                { 
                    id: "m26", name: "Grube Altenwald", coords: [49.3100, 7.0800], type: "Kohle", period: "1851-1932", 
                    desc: "Sulzbach. Hatte eine enge Verbindung zur Sulzbacher Hütte. Die Kohleförderung endete 1932, danach diente sie der Wasserhaltung." 
                },
                { 
                    id: "m27", name: "Grube Brefeld", coords: [49.3200, 7.0800], type: "Kohle", period: "1872-1967", 
                    desc: "Gelegen bei Sulzbach/Fischbach. Benannt nach dem preußischen Minister Brefeld." 
                },
                { 
                    id: "m28", name: "Grube Nordfeld", coords: [49.3800, 7.2500], type: "Kohle", period: "1889-1905", 
                    desc: "An der Grenze Waldmohr/Homburg. Ein eher kurzlebiges Bergwerk, das aufgrund schwieriger Verhältnisse geschlossen wurde." 
                },
                { 
                    id: "m29", name: "Grube Reisbach / A. Schäfer", coords: [49.3800, 6.9000], type: "Kohle", period: "1962-2000", 
                    desc: "Eine der wenigen Privatgruben (Dr. Arnold Schäfer) im Saarland, die noch lange nach der Gründung der Saarbergwerke AG existierte." 
                }
            ],
            steel: [
                { 
                    id: "s1", name: "Völklinger Hütte", coords: [49.2485, 6.8442], type: "Stahl", period: "UNESCO", 
                    desc: "Gegründet 1873. Die Roheisenproduktion wurde 1986 eingestellt. 1994 erklärte die UNESCO die Hütte zum Weltkulturerbe, da sie das weltweit einzige vollständig erhaltene Eisenwerk aus der Blütezeit der Industrialisierung ist." 
                },
                { 
                    id: "s2", name: "Dillinger Hütte", coords: [49.3480, 6.7450], type: "Stahl", period: "Aktiv", 
                    desc: "Gegründet 1685, ist sie die älteste Aktiengesellschaft Deutschlands. Sie ist weltweiter Marktführer für hochwertige Grobbleche, die u.a. in Brücken und Windkraftanlagen verbaut werden." 
                },
                { 
                    id: "s3", name: "Neunkircher Eisenwerk", coords: [49.3455, 7.1780], type: "Stahl", period: "1593-1982", 
                    desc: "Unter der Ära der Familie Stumm dominierte das Werk die Stadt Neunkirchen völlig. 1982 wurde der letzte Hochofen ausgeblasen. Teile der Anlage sind als Industriedenkmal erhalten." 
                },
                { 
                    id: "s4", name: "Halberger Hütte", coords: [49.2180, 7.0300], type: "Stahl", period: "Aktiv", 
                    desc: "Traditionsreicher Standort in Brebach-Fechingen, spezialisiert auf Gussrohre und Kurbelgehäuse für die Automobilindustrie (Halberg Guss)." 
                },
                { 
                    id: "s5", name: "Burbacher Hütte", coords: [49.2420, 6.9350], type: "Stahl", period: "Aktiv", 
                    desc: "Gegründet 1856. Heute ein wichtiger Standort von Saarstahl, spezialisiert auf Draht und Stabstahl. Die Hütte prägte den Saarbrücker Stadtteil Burbach maßgeblich." 
                },
                { 
                    id: "s6", name: "Alte Schmelz (St. Ingbert)", coords: [49.2750, 7.1050], type: "Eisen", period: "1733-1991", 
                    desc: "Ein bedeutendes Industriedenkmal. Hier wurde Eisenverarbeitung betrieben, die St. Ingbert zur Industriestadt machte. Die historischen Gebäude werden heute kulturell genutzt." 
                },
                { 
                    id: "s7", name: "Eisenwerk Homburg", coords: [49.3250, 7.3350], type: "Eisen", period: "19. Jh.", 
                    desc: "Wichtiger Standort für die pfälzisch-saarländische Eisenindustrie im 19. Jahrhundert, der die wirtschaftliche Bedeutung Homburgs stärkte." 
                },
                { 
                    id: "s8", name: "Mariahütte", coords: [49.6050, 6.9650], type: "Eisen", period: "ab 17. Jh.", 
                    desc: "Eine der ältesten Hütten im Hochwaldraum (Nonnweiler). Sie nutzte die Wasserkraft der Prims und lokale Erzvorkommen." 
                },
                { 
                    id: "s9", name: "Hubertushütte", coords: [49.5800, 6.9500], type: "Eisen", period: "1748-1868", 
                    desc: "Bierfeld (Nonnweiler). Eine weitere historische Hütte im Hochwald, die lokale Erze verarbeitete." 
                },
                { 
                    id: "s10", name: "Geislauterner Eisenwerk", coords: [49.2350, 6.8300], type: "Eisen", period: "1585-1875", 
                    desc: "Wiege der saarländischen Eisenindustrie in Völklingen. Hier soll der erste Koks-Hochofen des Reviers gestanden haben." 
                },
                { 
                    id: "s11", name: "Eisenwerk Bettingen", coords: [49.4350, 6.8600], type: "Eisen", period: "1686-1868", 
                    desc: "Namensgeber für den Ort 'Schmelz'. Ein bedeutendes Werk der frühen Eisenindustrie im Primsraum." 
                },
                { 
                    id: "s12", name: "Aschbacher Eisenwerk", coords: [49.2300, 6.9100], type: "Eisen", period: "1724-1860", 
                    desc: "Gersweiler. Eine typische Hütte der Barockzeit, die lokale Erze und Holzkohle nutzte." 
                },
                { 
                    id: "s13", name: "Fischbacher Schmelze", coords: [49.3150, 7.0400], type: "Eisen", period: "1728-1860", 
                    desc: "Frühindustrielle Anlage im Fischbachtal, bevor der Kohlebergbau dominierte." 
                },
                { 
                    id: "s14", name: "Goffontaine", coords: [49.2250, 7.0500], type: "Eisen", period: "18. Jh.", 
                    desc: "Schafbrücke. Bekannt für den Drahtzug und die Eisenverarbeitung vor den Toren Saarbrückens." 
                },
                { 
                    id: "s15", name: "Wadgasser Hütte", coords: [49.2700, 6.7900], type: "Eisen/Glas", period: "17.-19. Jh.", 
                    desc: "Ursprünglich Eisenverarbeitung, später weltberühmt für Kristallglas (Villeroy & Boch)." 
                },
                { 
                    id: "s16", name: "Karlsbrunner Hütte", coords: [49.1850, 6.8300], type: "Eisen", period: "18. Jh.", 
                    desc: "Im Warndt gelegen, nah beim Jagdschloss Karlsbrunn. Nutzte die reichen Holzvorkommen des Warndtwaldes." 
                },
                { 
                    id: "s17", name: "Hüttigweiler", coords: [49.3800, 7.0500], type: "Eisen", period: "Mittelalter", 
                    desc: "Der Ortsname bei Illingen zeugt von sehr alter Verhüttungstradition in dieser Gegend." 
                },
                { 
                    id: "s18", name: "Hütte Wecklingen", coords: [49.2300, 7.2500], type: "Eisen", period: "18. Jh.", 
                    desc: "Kleine historische Anlage im Bliestal (Blieskastel)." 
                },
                { 
                    id: "s19", name: "St. Ingberter Eisenwerk", coords: [49.2800, 7.1200], type: "Eisen", period: "19. Jh.", 
                    desc: "Neben der Alten Schmelz ein weiterer wichtiger Standort für Draht- und Nagelproduktion." 
                },
                { 
                    id: "s20", name: "Röhrenwerke Bous", coords: [49.2750, 6.8050], type: "Stahl", period: "Aktiv", 
                    desc: "Mannesmann Röhrenwerke. Spezialisiert auf die Herstellung nahtloser Stahlrohre." 
                }
            ],
            rails: []
        };

        const urbanData = [
            { name: "Saarbrücken", coords: [49.2333, 7.0000], pop: 181900, desc: "Landeshauptstadt & Zentrum" },
            { name: "Völklingen", coords: [49.2500, 6.8500], pop: 40000, desc: "Mittelstadt / Stahlstandort" },
            { name: "Püttlingen", coords: [49.2900, 6.8900], pop: 18500, desc: "Köllertal Zentrum" },
            { name: "Heusweiler", coords: [49.3400, 6.9300], pop: 18000, desc: "Marktort im Köllertal" },
            { name: "Sulzbach", coords: [49.3000, 7.0600], pop: 16000, desc: "Industriegeschichte" },
            { name: "Friedrichsthal", coords: [49.3250, 7.0950], pop: 10000, desc: "Ehem. Bergbau" },
            { name: "Quierschied", coords: [49.3250, 7.0500], pop: 13000, desc: "Ehem. Grubenstandort" },
            { name: "Kleinblittersdorf", coords: [49.1550, 7.0350], pop: 11000, desc: "Obere Saar" },
            { name: "Riegelsberg", coords: [49.3100, 6.9400], pop: 14500, desc: "Wohnort an Saarbahn" },
            { name: "Neunkirchen", coords: [49.3450, 7.1780], pop: 46900, desc: "Zweitgrößte Stadt" },
            { name: "Eppelborn", coords: [49.4050, 6.9650], pop: 17000, desc: "Illtal Zentrum" },
            { name: "Illingen", coords: [49.3750, 7.0500], pop: 16500, desc: "Verkehrsknoten" },
            { name: "Merchweiler", coords: [49.3600, 7.0600], pop: 10000, desc: "Bergbautradition" },
            { name: "Ottweiler", coords: [49.4050, 7.1650], pop: 14500, desc: "Kreisstadt / Historisch" },
            { name: "Schiffweiler", coords: [49.3700, 7.1300], pop: 15500, desc: "Nahe Grube Reden" },
            { name: "Spiesen-Elversberg", coords: [49.3200, 7.1500], pop: 12800, desc: "Sport & Wohnen" },
            { name: "Homburg", coords: [49.3200, 7.3400], pop: 42000, desc: "Uniklinik & Industrie" },
            { name: "St. Ingbert", coords: [49.2800, 7.1200], pop: 35500, desc: "Biosphäre Bliesgau" },
            { name: "Blieskastel", coords: [49.2383, 7.2567], pop: 20500, desc: "Barockstadt" },
            { name: "Bexbach", coords: [49.3500, 7.2600], pop: 17500, desc: "Bergbaumuseum" },
            { name: "Mandelbachtal", coords: [49.1800, 7.1300], pop: 10500, desc: "Ländlich / Bliesgau" },
            { name: "Saarlouis", coords: [49.3167, 6.7500], pop: 34500, desc: "Festungsstadt" },
            { name: "Dillingen", coords: [49.3500, 6.7333], pop: 20000, desc: "Hüttenstadt" },
            { name: "Lebach", coords: [49.4100, 6.9100], pop: 19000, desc: "Mittelpunkt" },
            { name: "Schmelz", coords: [49.4300, 6.8600], pop: 16000, desc: "Primsland" },
            { name: "Wadgassen", coords: [49.2700, 6.7900], pop: 17000, desc: "Outlet & Industrie" },
            { name: "Schwalbach", coords: [49.3000, 6.8300], pop: 17000, desc: "Wohnort" },
            { name: "Rehlingen-Siersburg", coords: [49.3500, 6.6800], pop: 14500, desc: "Niedtal" },
            { name: "St. Wendel", coords: [49.4667, 7.1667], pop: 25500, desc: "Wirtschaftszentrum" },
            { name: "Tholey", coords: [49.4800, 7.0300], pop: 12000, desc: "Schaumberg" },
            { name: "Nohfelden", coords: [49.5800, 7.1500], pop: 10000, desc: "Bostalsee" },
            { name: "Merzig", coords: [49.4419, 6.6378], pop: 30000, desc: "Kreisstadt" },
            { name: "Losheim am See", coords: [49.5100, 6.7500], pop: 16000, desc: "Tourismus" },
            { name: "Beckingen", coords: [49.3800, 6.7000], pop: 15000, desc: "Untere Saar" },
            { name: "Mettlach", coords: [49.4900, 6.5900], pop: 12000, desc: "Keramik (V&B)" }
        ];

        const transportData = [
            { name: "RE 1 / RB 70/71", desc: "Trier - SB - Homburg - Mannheim", color: "#db2777", weight: 5, path: [[49.600, 6.550], [49.490, 6.590], [49.441, 6.637], [49.350, 6.733], [49.316, 6.750], [49.250, 6.850], [49.233, 7.000], [49.280, 7.120], [49.320, 7.340], [49.380, 7.350]] },
            { name: "RE 3 / RB 73", desc: "SB - Neunkirchen - Mainz", color: "#0ea5e9", weight: 4, path: [[49.233, 7.000], [49.300, 7.060], [49.345, 7.178], [49.405, 7.165], [49.466, 7.166], [49.580, 7.150], [49.630, 7.180]] },
            { name: "RB 68", desc: "SB - St. Ingbert - Zweibrücken", color: "#2563eb", weight: 3, path: [[49.233, 7.000], [49.280, 7.120], [49.250, 7.250], [49.240, 7.350]] },
            { name: "RB 72", desc: "SB - Illingen - Lebach", color: "#8b5cf6", weight: 3, path: [[49.233, 7.000], [49.325, 7.050], [49.375, 7.050], [49.410, 6.910]] },
            { name: "RB 77", desc: "Dillingen - Niedaltdorf", color: "#64748b", weight: 3, path: [[49.350, 6.733], [49.350, 6.600]] },
            { name: "Saarbahn S1", desc: "Lebach - SB - Saargemünd", color: "#eab308", weight: 4, path: [[49.410, 6.910], [49.340, 6.930], [49.310, 6.940], [49.233, 7.000], [49.218, 7.030], [49.155, 7.035], [49.110, 7.080]] }
        ];

        // ---------------------------------------------------------
        // MAP SETUP
        // ---------------------------------------------------------
        
        const map = L.map('map', { zoomControl: false }).setView([49.38, 6.95], 10); 
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        let currentLayers = L.layerGroup().addTo(map);
        let borderLayer = L.layerGroup().addTo(map);

        L.polygon(saarlandBorder, {
            color: '#64748b', weight: 2, fill: false, dashArray: '6, 6', opacity: 0.75
        }).addTo(borderLayer);

        // ---------------------------------------------------------
        // HELPER & RENDERER
        // ---------------------------------------------------------

        function clearMap() {
            currentLayers.clearLayers();
            document.getElementById('sidebar-content').innerHTML = '';
        }

        // INTERAKTION: SIDEBAR DETAILS ÖFFNEN
        function expandSidebarItem(id) {
            const contentDiv = document.getElementById(`details-${id}`);
            if (contentDiv) {
                // Alle anderen schließen (optional, aber übersichtlicher)
                document.querySelectorAll('.details-content').forEach(el => {
                    if(el.id !== `details-${id}`) el.classList.remove('open');
                });
                
                contentDiv.classList.add('open');
                
                // Scrollen
                contentDiv.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Visuelles Feedback (Highlight)
                contentDiv.parentElement.classList.add('ring-2', 'ring-slate-400');
                setTimeout(() => contentDiv.parentElement.classList.remove('ring-2', 'ring-slate-400'), 1000);
            }
        }

        function createExpandableListItem(item, iconClass, colorClass, onClickMarker) {
            const div = document.createElement('div');
            div.className = `group rounded-xl bg-white border border-slate-100 hover:border-slate-300 shadow-sm hover:shadow-md transition-all duration-200 mb-2 overflow-hidden`;
            
            const dotColor = colorClass.replace('border-', 'bg-').replace('text-', 'bg-');
            
            // Header (immer sichtbar)
            const header = document.createElement('div');
            header.className = "p-3.5 flex items-center gap-3.5 cursor-pointer";
            header.onclick = () => {
                // Toggle Details
                const details = document.getElementById(`details-${item.id}`);
                details.classList.toggle('open');
                if(onClickMarker) onClickMarker(); // Auch zur Karte fliegen
            };

            header.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-xl text-slate-500 group-hover:text-slate-800">
                    <i class="${iconClass}"></i>
                </div>
                <div class="flex-1">
                    <div class="font-bold text-sm text-slate-800">${item.name}</div>
                    <div class="text-xs text-slate-500 font-medium">${item.period}</div>
                </div>
                <div class="w-2 h-2 rounded-full ${dotColor}"></div>
            `;

            // Details (versteckt) - BILD ENTFERNT
            const details = document.createElement('div');
            details.id = `details-${item.id}`;
            details.className = "details-content bg-slate-50 text-xs text-slate-600 px-4";
            details.innerHTML = `
                <div class="py-3 border-t border-slate-200">
                    <p class="leading-relaxed text-justify">${item.desc}</p>
                </div>
            `;

            div.appendChild(header);
            div.appendChild(details);
            return div;
        }

        // --- ICONS ---
        const getMineIcon = (color) => L.divIcon({
            className: 'custom-div-icon',
            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter, sans-serif">G</text></svg>`,
            iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
        });

        const getOreIcon = (color) => L.divIcon({
            className: 'custom-div-icon',
            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter, sans-serif">E</text></svg>`,
            iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
        });

        const getSteelIcon = (color) => L.divIcon({
            className: 'custom-div-icon',
            html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 drop-shadow-lg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><text x="12" y="15" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="900" font-family="Inter, sans-serif">H</text></svg>`,
            iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
        });

        // --- LEGENDE RENDERN ---
        function renderLegend(mode) {
            const container = document.getElementById('legend-content');
            const panel = document.getElementById('legend-panel');
            let html = '';

            // Im Verkehrs-Modus die Legende komplett ausblenden
            if (mode === 'transport') {
                panel.classList.add('hidden');
                panel.classList.remove('md:block');
                return;
            }

            // Für andere Modi: Legende anzeigen (auf Desktop)
            panel.classList.remove('hidden');
            panel.classList.add('md:block');

            // Common legend item for border
            const borderLegend = `
                <div class="flex items-center gap-2.5 mt-2 pt-2 border-t border-slate-100">
                    <span class="w-6 h-0 border-t-2 border-dashed border-slate-400"></span>
                    <span class="text-slate-500">grobe Landesgrenze</span>
                </div>
            `;

            if (mode === 'history') {
                html = `
                    <div class="flex items-center gap-2.5">
                        <span class="w-3 h-3 rounded-full bg-red-500 border border-white shadow-sm"></span>
                        <span>Steinkohlebergwerk</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <span class="w-3 h-3 rounded-full bg-orange-500 border border-white shadow-sm"></span>
                        <span>Erz-/Kalkbergwerk</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <span class="w-3 h-3 rounded-full bg-slate-600 border border-white shadow-sm"></span>
                        <span>Stahl-/Hüttenwerk</span>
                    </div>
                    <div class="mt-2 pt-2 border-t border-slate-100">
                        <div class="flex items-center gap-2.5">
                            <span class="w-4 h-1 bg-red-500 rounded-full opacity-50"></span>
                            <span class="text-[10px] text-slate-500">Kohlegürtel (in Übersicht)</span>
                        </div>
                        <div class="flex items-center gap-2.5">
                            <span class="w-4 h-1 bg-slate-600 rounded-full opacity-50"></span>
                            <span class="text-[10px] text-slate-500">Stahlachse (in Übersicht)</span>
                        </div>
                    </div>
                `;
            } else if (mode === 'urban') {
                html = `
                    <div class="flex items-center gap-2.5">
                        <span class="w-3 h-3 rounded-full bg-purple-700 opacity-60"></span>
                        <span>> 100.000 EW</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <span class="w-3 h-3 rounded-full bg-purple-500 opacity-60"></span>
                        <span>> 30.000 EW</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <span class="w-3 h-3 rounded-full bg-purple-300 opacity-60"></span>
                        <span>< 30.000 EW</span>
                    </div>
                `;
            } 
            
            container.innerHTML = html + borderLegend;
        }

        // --- HELPER FOR OVERVIEW LINES ---
        function addOverviewLines(containerList) {
            const miningLine = L.polyline(overviewLines.mining.path, {
                color: overviewLines.mining.color, weight: 20, opacity: 0.3, lineCap: 'round', lineJoin: 'round', interactive: false
            }).addTo(currentLayers);
            
            const steelLine = L.polyline(overviewLines.steel.path, {
                color: overviewLines.steel.color, weight: 20, opacity: 0.3, lineCap: 'round', lineJoin: 'round', interactive: false
            }).addTo(currentLayers);

            if (containerList) {
                const overlayInfo = document.createElement('div');
                overlayInfo.className = "mt-4 p-2 border-t border-slate-200 text-[10px] text-slate-400 text-center uppercase tracking-wider";
                overlayInfo.innerHTML = "Industrieachsen eingeblendet";
                containerList.appendChild(overlayInfo);
            }
        }

        function setViewMode(view) {
            currentViewMode = view;
            
            if (view === 'details') {
                document.getElementById('view-details').className = "px-3 py-1.5 rounded-md text-xs font-bold bg-slate-800 text-white shadow transition-all flex items-center gap-1";
                document.getElementById('view-overview').className = "px-3 py-1.5 rounded-md text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all flex items-center gap-1";
            } else {
                document.getElementById('view-details').className = "px-3 py-1.5 rounded-md text-xs font-bold text-slate-600 hover:bg-slate-100 transition-all flex items-center gap-1";
                document.getElementById('view-overview').className = "px-3 py-1.5 rounded-md text-xs font-bold bg-slate-800 text-white shadow transition-all flex items-center gap-1";
            }

            clearMap();
            if (currentMode === 'history') renderHistory();
            if (currentMode === 'urban') renderUrban();
            if (currentMode === 'transport') renderTransport();
        }

        function renderHistory() {
            document.getElementById('sidebar-title').innerText = "Berg- und Stahlbau";
            document.getElementById('sidebar-desc').innerText = "Kohle, Erz & Stahl";
            const list = document.getElementById('sidebar-content');

            if (currentViewMode === 'overview') {
                const miningLine = L.polyline(overviewLines.mining.path, {
                    color: overviewLines.mining.color, weight: 20, opacity: 0.4, lineCap: 'round', lineJoin: 'round'
                }).addTo(currentLayers);
                miningLine.bindTooltip(overviewLines.mining.name, {sticky: true, direction: 'center', className: 'font-bold text-red-600 bg-white border-0 shadow-lg'});
                
                const steelLine = L.polyline(overviewLines.steel.path, {
                    color: overviewLines.steel.color, weight: 20, opacity: 0.4, lineCap: 'round', lineJoin: 'round'
                }).addTo(currentLayers);
                steelLine.bindTooltip(overviewLines.steel.name, {sticky: true, direction: 'center', className: 'font-bold text-slate-600 bg-white border-0 shadow-lg'});
                
                const infoBox = document.createElement('div');
                infoBox.className = "p-4 bg-slate-50/50 text-slate-800 text-xs rounded-xl mb-4 border border-slate-200 shadow-sm leading-relaxed mt-4";
                infoBox.innerHTML = "<strong class='block mb-1 font-bold'>Strukturanalyse</strong>Die Linien abstrahieren die Verteilung der über 50 Standorte und zeigen die zwei Hauptentwicklungsachsen des Landes.";
                list.appendChild(infoBox);

            } else {
                // --- HISTORY DETAILS (MARKER) ---
                historyData.mines.forEach(mine => {
                    let icon, color;
                    if (mine.type === "Kohle") { icon = getMineIcon('#ef4444'); color = "bg-red-500"; } 
                    else { icon = getOreIcon('#f97316'); color = "bg-orange-500"; }

                    const marker = L.marker(mine.coords, { icon: icon }).addTo(currentLayers);
                    
                    // Minimalist Popup with Link (Mines) - BILD ENTFERNT
                    const popupContent = `
                        <div class="w-full bg-white p-3">
                            <div class="flex justify-between items-start">
                                <b class="${mine.type==='Kohle'?'text-red-600':'text-orange-600'} block text-sm">${mine.name}</b>
                                <span class="${mine.type==='Kohle'?'bg-red-50 text-red-600 border-red-100':'bg-orange-50 text-orange-600 border-orange-100'} text-[9px] font-bold px-1.5 py-0.5 rounded border">${mine.type}</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-1 mb-3">${mine.period}</div>
                            <button onclick="expandSidebarItem('${mine.id}')" class="w-full text-center bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-bold py-1.5 rounded transition-colors">
                                Weitere Informationen →
                            </button>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    
                    list.appendChild(createExpandableListItem(mine, mine.type === "Kohle" ? "ph-pick-axe" : "ph-mountains", color, () => {
                        map.flyTo(mine.coords, 13);
                        marker.openPopup();
                    }));
                });

                historyData.steel.forEach(steel => {
                    const marker = L.marker(steel.coords, { icon: getSteelIcon('#475569') }).addTo(currentLayers);
                    
                    // Minimalist Popup with Link (Steel) - BILD ENTFERNT
                    const popupContent = `
                        <div class="w-full bg-white p-3">
                            <div class="flex justify-between items-start">
                                <b class="text-slate-700 block text-sm">${steel.name}</b>
                                <span class="bg-slate-50 text-slate-600 text-[9px] font-bold px-1.5 py-0.5 rounded border border-slate-200">${steel.type}</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-1 mb-3">${steel.period}</div>
                            <button onclick="expandSidebarItem('${steel.id}')" class="w-full text-center bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-bold py-1.5 rounded transition-colors">
                                Weitere Informationen →
                            </button>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    
                    list.appendChild(createExpandableListItem(steel, "ph-factory", "bg-slate-600", () => {
                        map.flyTo(steel.coords, 13);
                        marker.openPopup();
                    }));
                });
            }
        }

        function renderUrban() {
            document.getElementById('sidebar-title').innerText = "Bevölkerung";
            document.getElementById('sidebar-desc').innerText = "Nach Gemeinden (Stand ~2023)";
            const list = document.getElementById('sidebar-content');
            
            const infoBox = document.createElement('div');
            infoBox.className = "p-4 bg-blue-50/50 text-blue-900 text-xs rounded-xl mb-4 border border-blue-100 shadow-sm leading-relaxed";
            
            if (currentViewMode === 'overview') {
                infoBox.innerHTML = "<strong class='block mb-1 font-bold'>Korrelation sichtbar!</strong>Die Überlagerung zeigt: Die größten Bevölkerungszentren (Lila Kreise) liegen exakt auf dem roten Kohlegürtel und der grauen Stahlachse.";
                addOverviewLines(list);
            } else {
                infoBox.innerHTML = "<strong class='block mb-1 font-bold'>Analyse</strong>Klicke oben auf 'Übersicht', um den direkten Zusammenhang zwischen Industrieachsen und Besiedlung einzublenden.";
            }
            list.appendChild(infoBox);

            urbanData.forEach(city => {
                const radius = Math.sqrt(city.pop) * 14; 
                let color = city.pop > 100000 ? '#7e22ce' : (city.pop > 30000 ? '#a855f7' : '#d8b4fe');

                const circle = L.circle(city.coords, {
                    color: color, fillColor: color, fillOpacity: 0.4, radius: radius, weight: 1
                }).addTo(currentLayers);

                circle.bindPopup(`<div class="text-center p-1"><b class="text-lg block mb-1">${city.name}</b><span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs font-bold">${city.pop.toLocaleString()} EW</span><br><span class="text-xs text-slate-500 mt-2 block">${city.desc}</span></div>`);
                
                const div = document.createElement('div');
                div.className = "p-3 mb-2 bg-white rounded-lg border-l-4 border-purple-500 shadow-sm text-sm";
                div.innerHTML = `<b>${city.name}</b><br><span class="text-xs text-slate-500">${city.pop.toLocaleString()} EW</span>`;
                div.onclick = () => { map.flyTo(city.coords, 13); circle.openPopup(); };
                list.appendChild(div);
            });
        }

        function renderTransport() {
            document.getElementById('sidebar-title').innerText = "Schienennetz";
            document.getElementById('sidebar-desc').innerText = "Aktive RE/RB & Saarbahn Linien";
            const list = document.getElementById('sidebar-content');

            if (currentViewMode === 'overview') {
                const infoBox = document.createElement('div');
                infoBox.className = "p-4 bg-blue-50/50 text-blue-900 text-xs rounded-xl mb-4 border border-blue-100 shadow-sm leading-relaxed";
                infoBox.innerHTML = "<strong class='block mb-1 font-bold'>Historische Pfade</strong>Das moderne Schienennetz folgt fast identisch den alten Transportwegen der Kohle (Rot) und des Stahls (Grau).";
                list.appendChild(infoBox);
                addOverviewLines(list);
            }

            transportData.forEach(route => {
                const poly = L.polyline(route.path, { 
                    color: route.color, weight: route.weight, opacity: 0.8, lineCap: 'round'
                }).addTo(currentLayers);
                poly.bindTooltip(route.name, {sticky: true, className: 'font-bold bg-white border-0 shadow-lg px-2 py-1 rounded'});

                const div = document.createElement('div');
                div.className = "p-3 mb-2 bg-white rounded-lg border-l-4 shadow-sm text-sm cursor-pointer hover:bg-slate-50";
                div.style.borderLeftColor = route.color;
                div.innerHTML = `<b>${route.name}</b><br><span class="text-xs text-slate-500">${route.desc}</span>`;
                div.onclick = () => { map.fitBounds(poly.getBounds()); };
                list.appendChild(div);
            });
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-slate-600', 'bg-transparent'); 
            });
            
            const activeBtn = document.getElementById(`btn-${mode}`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('text-slate-600', 'bg-transparent');

            if(mode === 'history' || mode === 'urban' || mode === 'transport') {
                 document.getElementById('view-controls').classList.remove('hidden');
            } 

            renderLegend(mode); // Update Legend
            clearMap();
            
            if (mode === 'history') renderHistory();
            if (mode === 'urban') renderUrban();
            if (mode === 'transport') renderTransport();
        }

        // Init
        setTimeout(() => {
            switchMode('history');
        }, 100);
    </script>
</body>
</html>
